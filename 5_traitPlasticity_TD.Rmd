---
title: "Trait Plasticity based on climate transfer distance"
author: "Anoob Prakash"
date: "03/03/2021"
output:
  rmarkdown::html_document:
    theme: cosmo  
    number_sections: false
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
# setwd("Z:/Anoob/MCMCglmm")

suppressPackageStartupMessages({
# packages
require(MCMCglmm)
require(lmerTest)
require(dplyr)
require(tidyr)
require(data.table)
require(ggplot2)
require(cowplot)
})

# data 
budset_2019 <- read.csv("./trait_data/BudSet_2019.csv")
budset_2020 <- read.csv("./trait_data/BudSet_2020.csv")
budbreak_2020 <- read.csv("./trait_data/BudBreak_2020_cGDD.csv")
heightGrowth_2019 <- read.csv("./trait_data/Growth_2019.csv")
heightGrowth_2020 <- read.csv("./trait_data/Growth_2020.csv")
Plasticity <- read.csv("./trait_data/Plasticity.csv")
Meta <- read.table("./Exome/RS_Exome_metadata.txt", sep="\t",header=T)
```

## Climate Transfer Distance  
 - CTD based on MAT  
 - Plasticity = (trait @ home - trait @ away ) / (trait @ home)   
 
```{r}
Garden_MAT <- read.csv("./ClimateNA/envGarden_Year_2019Y.csv")
Garden_MAT

# MAT for 2020
# source: http://scacis.rcc-acis.org/  
VT_MAT <- round(((sum(26.1, 24.8, 37.3, 43.4, 57.9, 69.0, 76.8, 71.0, 62.1, 50.1, 43.3, 31.3)/12)-32)*(5/9),1)
MD_MAT <- round(((sum(31.7, 33.3, 43.3, 44.2, 54.4, 65.6, 73.5, 69.9, 60.5, 52.2, 45.4, 30.7)/12)-32)*(5/9),1)
NC_MAT <- round(((sum(40.2, 42.1, 51.6, 54.5, 60.7, 72.1, 79.3, 75.8, 66.0, 59.0, 51.7, 37.6)/12)-32)*(5/9),1)

Garden_MAT_2020 <- data.frame(Garden=c("VT_coords","MD_coords","NC_coords"),
                         MAT=c(VT_MAT,MD_MAT,NC_MAT))
Garden_MAT_2020
  
Provenance_MAT <- readxl::read_xlsx("./ClimateNA/spruce_envVar_PCA_210118.xlsx")
```

## Home vs Away site allocation  
```{r}
Meta$gMAT <- NA
Meta_VT <- Meta; Meta_VT$Garden <- "Vermont"
Meta_MD <- Meta; Meta_MD$Garden <- "Maryland"
Meta_NC <- Meta; Meta_NC$Garden <- "North_Carolina"
Meta <- rbind(Meta_VT,Meta_MD,Meta_NC)

Meta[Meta$Garden=="Vermont","gMAT"] <- Garden_MAT[Garden_MAT$ID1=="VT_coords","MAT"]
Meta[Meta$Garden=="Maryland","gMAT"] <- Garden_MAT[Garden_MAT$ID1=="MD_coords","MAT"]
Meta[Meta$Garden=="North_Carolina","gMAT"] <- Garden_MAT[Garden_MAT$ID1=="NC_coords","MAT"]

Meta <- merge(x=Meta,
                     y=Provenance_MAT[,c("site","MAT")],
                     by.x="Pop",
                     by.y="site")

colnames(Meta)[colnames(Meta)=="MAT"] <- "pMAT"
Meta$TD <- Meta$gMAT - Meta$pMAT
Meta$TD2 <- Meta$TD*Meta$TD

# seperate out away and home sites based on the CTD/TD  
Meta2 <- as.data.table(Meta)
Meta_home <- setDT(Meta2)[, .SD[which.min(abs(TD))], by=Family]
Meta_away <- setDT(Meta2)[, .SD[which.max(abs(TD))], by=Family]

table(Meta_home$Garden)
table(Meta_away$Garden)

Meta_home[Meta_home$Garden=="Maryland",]
Meta_away[Meta_away$Garden=="Vermont",]

```

# Data Curation   {.tabset .tabset-fade .tabset-pills}  

## Bud set 2019  
```{r}
# budset_2019$pMAT <- NA # provenance MAT
budset_2019$gMAT <- NA # garden MAT
budset_2019[budset_2019$Garden=="Vermont","gMAT"] <- Garden_MAT[Garden_MAT$ID1=="VT_coords","MAT"]
budset_2019[budset_2019$Garden=="Maryland","gMAT"] <- Garden_MAT[Garden_MAT$ID1=="MD_coords","MAT"]
budset_2019[budset_2019$Garden=="North_Carolina","gMAT"] <- Garden_MAT[Garden_MAT$ID1=="NC_coords","MAT"]

budset_2019 <- merge(x=budset_2019,
                     y=Provenance_MAT[,c("site","MAT")],
                     by.x="Population",
                     by.y="site")

colnames(budset_2019)[colnames(budset_2019)=="MAT"] <- "pMAT"
budset_2019$TD <- budset_2019$gMAT - budset_2019$pMAT
budset_2019$TD2 <- budset_2019$TD*budset_2019$TD # to check for the quadreatic relationship between transfer distance and response variable

# family_garden column
budset_2019 <- budset_2019 %>% unite(Family_gardenID, Family, Garden, sep = "_", remove = FALSE)
# budset_2019 <- budset_2019 %>% unite(Pop_gardenID, Population, Garden, sep = "_", remove = FALSE)

# per site
budset_2019_VT <- budset_2019 %>% filter(Garden == "Vermont")
budset_2019_MD <- budset_2019 %>% filter(Garden == "Maryland")
budset_2019_NC <- budset_2019 %>% filter(Garden == "North_Carolina")

# Vermont
bs_2019_VT <- lmer(BudSet ~ 1 + (1|Bed) + (1|Family), budset_2019_VT)
bs_2019_VT <- coef(bs_2019_VT)
bs_2019_VT <- bs_2019_VT$Family
bs_2019_VT <- cbind(Family=rownames(bs_2019_VT),bs_2019_VT)
rownames(bs_2019_VT) <- NULL

# Maryland
bs_2019_MD <- lmer(BudSet ~ 1 + (1|Bed) + (1|Family), budset_2019_MD)
bs_2019_MD <- coef(bs_2019_MD)
bs_2019_MD <- bs_2019_MD$Family
bs_2019_MD <- cbind(Family=rownames(bs_2019_MD),bs_2019_MD)
rownames(bs_2019_MD) <- NULL

# North Carolina
bs_2019_NC <- lmer(BudSet ~ 1 + (1|Bed) + (1|Family), budset_2019_NC)
bs_2019_NC <- coef(bs_2019_NC)
bs_2019_NC <- bs_2019_NC$Family
bs_2019_NC <- cbind(Family=rownames(bs_2019_NC),bs_2019_NC)
rownames(bs_2019_NC) <- NULL

# large no .of families missing at the NC site, remove the excess families from other sites
bs_2019_VT <- bs_2019_VT[(bs_2019_VT$Family %in% bs_2019_NC$Family),]; nrow(bs_2019_VT[(bs_2019_VT$Family %in% bs_2019_MD$Family),])
bs_2019_MD <- bs_2019_MD[(bs_2019_MD$Family %in% bs_2019_NC$Family),]

# add garden column
bs_2019_VT$Garden <- "Vermont"
bs_2019_MD$Garden <- "Maryland"
bs_2019_NC$Garden <- "North_Carolina"

bs_2019_VT <- bs_2019_VT %>% unite(Family_gardenID, Family, Garden, sep = "_", remove = FALSE)
bs_2019_MD <- bs_2019_MD %>% unite(Family_gardenID, Family, Garden, sep = "_", remove = FALSE)
bs_2019_NC <- bs_2019_NC %>% unite(Family_gardenID, Family, Garden, sep = "_", remove = FALSE)

# combine family level data
budsetPlasticity_2019 <- rbind(bs_2019_VT,bs_2019_MD,bs_2019_NC)
colnames(budsetPlasticity_2019)[colnames(budsetPlasticity_2019)=="(Intercept)"] <- "BudSet_2019"

# add transfer distance
budsetPlasticity_2019 <- merge(x=budsetPlasticity_2019,
                                y=budset_2019[,c("Family_gardenID","TD","TD2")],
                               by="Family_gardenID")
```

**Budset 2019 v CTD**  
```{r}
budset_2019$mBed <- paste0(budset_2019$Region,"_",budset_2019$Bed)

budset_2019$Region <- factor(budset_2019$Region,levels = c("Core", "Margin", "Edge")) 

budset_2019_modTD <- lmer(BudSet ~ Garden * TD + Region + (1|Family) + (1|Population) + (1|mBed), data=budset_2019)


# trait vs TD
budset2019_TD <-      ggplot(data=budset_2019,
                           aes(x= TD,y=BudSet, color=Region)) + 
                            geom_point(aes(shape = Region), size=2, alpha = 0.2) + 
                              geom_smooth(method='lm', se=F, formula=y~x) + # formula=y~poly(x,2)) +
                                scale_color_manual(values = c("Core" = "goldenrod2","Edge"="steelblue","Margin"="green2")) +
                                  labs(x = "", 
                                       y = "Bud set in 2019 (DOY)") + 
                                    theme_bw() + theme(axis.text=element_text(size=18), 
                                         axis.title=element_text(size=20), #face="bold"),
                                         legend.title = element_text(color = "black", size = 23),
                                         legend.text = element_text(color = "black", size = 23))
```


```{r}
budsetPlasticity_2019 <- as.data.table(budsetPlasticity_2019)
budset_2019_home <- setDT(budsetPlasticity_2019)[, .SD[which.min(abs(TD))], by=Family]
budset_2019_away <- setDT(budsetPlasticity_2019)[, .SD[which.max(abs(TD))], by=Family]

colnames(budset_2019_home)[colnames(budset_2019_home)=="BudSet_2019"] <- "home"
colnames(budset_2019_away)[colnames(budset_2019_away)=="BudSet_2019"] <- "away"
budsetPlasticity_2019 <- merge(x=budset_2019_home[,-c("TD","TD2")],
                               y=budset_2019_away[,c("Family","away")],
                               by="Family")
# # file for step 10
# file10_bs19 <- budsetPlasticity_2019
# file10_bs19$Trait <- "BudSet2019"
# file10_bs19 <- file10_bs19 %>% tidyr::pivot_longer(cols=c("home","away"),
#                                                            names_to = "Environment",
#                                                            values_to = "value")


budsetPlasticity_2019$BudSet2019_Plasticity <- (budsetPlasticity_2019$home - budsetPlasticity_2019$away)/budsetPlasticity_2019$home

```
 
## Bud set 2020  
```{r}
# budset_2020$pMAT <- NA # provenance MAT
budset_2020$gMAT <- NA # garden MAT
budset_2020[budset_2020$Garden=="Vermont","gMAT"] <- Garden_MAT_2020[Garden_MAT_2020$Garden=="VT_coords","MAT"]
budset_2020[budset_2020$Garden=="Maryland","gMAT"] <- Garden_MAT_2020[Garden_MAT_2020$Garden=="MD_coords","MAT"]
budset_2020[budset_2020$Garden=="North_Carolina","gMAT"] <- Garden_MAT_2020[Garden_MAT_2020$Garden=="NC_coords","MAT"]

budset_2020 <- merge(x=budset_2020,
                     y=Provenance_MAT[,c("site","MAT")],
                     by.x="Population",
                     by.y="site")

colnames(budset_2020)[colnames(budset_2020)=="MAT"] <- "pMAT"
budset_2020$TD <- budset_2020$gMAT - budset_2020$pMAT
budset_2020$TD2 <- budset_2020$TD*budset_2020$TD # to check for the quadreatic relationship between transfer distance and response variable

# family_garden column
budset_2020 <- budset_2020 %>% unite(Family_gardenID, Family, Garden, sep = "_", remove = FALSE)
# budset_2020 <- budset_2020 %>% unite(Pop_gardenID, Population, Garden, sep = "_", remove = FALSE)

# per site
budset_2020_VT <- budset_2020 %>% filter(Garden == "Vermont")
budset_2020_MD <- budset_2020 %>% filter(Garden == "Maryland")
budset_2020_NC <- budset_2020 %>% filter(Garden == "North_Carolina")

# Vemont
bs_2020_VT <- lmer(BudSet ~ 1 + (1|Bed) + (1|Family), budset_2020_VT)
bs_2020_VT <- coef(bs_2020_VT)
bs_2020_VT <- bs_2020_VT$Family
bs_2020_VT <- cbind(Family=rownames(bs_2020_VT),bs_2020_VT)
rownames(bs_2020_VT) <- NULL

# Maryland
bs_2020_MD <- lmer(BudSet ~ 1 + (1|Bed) + (1|Family), budset_2020_MD)
bs_2020_MD <- coef(bs_2020_MD)
bs_2020_MD <- bs_2020_MD$Family
bs_2020_MD <- cbind(Family=rownames(bs_2020_MD),bs_2020_MD)
rownames(bs_2020_MD) <- NULL

# North Carolina
bs_2020_NC <- lmer(BudSet ~ 1 + (1|Bed) + (1|Family), budset_2020_NC)
bs_2020_NC <- coef(bs_2020_NC)
bs_2020_NC <- bs_2020_NC$Family
bs_2020_NC <- cbind(Family=rownames(bs_2020_NC),bs_2020_NC)
rownames(bs_2020_NC) <- NULL

# large no .of families missing at the NC site, remove the excess families from other sites
bs_2020_VT <- bs_2020_VT[(bs_2020_VT$Family %in% bs_2020_NC$Family),]; nrow(bs_2020_VT[(bs_2020_VT$Family %in% bs_2020_MD$Family),])
bs_2020_MD <- bs_2020_MD[(bs_2020_MD$Family %in% bs_2020_NC$Family),]

# add garden column
bs_2020_VT$Garden <- "Vermont"
bs_2020_MD$Garden <- "Maryland"
bs_2020_NC$Garden <- "North_Carolina"

bs_2020_VT <- bs_2020_VT %>% unite(Family_gardenID, Family, Garden, sep = "_", remove = FALSE)
bs_2020_MD <- bs_2020_MD %>% unite(Family_gardenID, Family, Garden, sep = "_", remove = FALSE)
bs_2020_NC <- bs_2020_NC %>% unite(Family_gardenID, Family, Garden, sep = "_", remove = FALSE)

# combine family level data
budsetPlasticity_2020 <- rbind(bs_2020_VT,bs_2020_MD,bs_2020_NC)
colnames(budsetPlasticity_2020)[colnames(budsetPlasticity_2020)=="(Intercept)"] <- "BudSet_2020"

# add transfer distance
budsetPlasticity_2020 <- merge(x=budsetPlasticity_2020,
                                y=budset_2020[,c("Family_gardenID","TD","TD2")],
                                by="Family_gardenID")
# trait vs TD
ggplot(data=budset_2020,
         aes(x= TD,y=BudSet)) + 
          geom_point() + 
            geom_smooth(method='lm', se=F, formula=y~poly(x,2))  


budsetPlasticity_2020 <- as.data.table(budsetPlasticity_2020)
budset_2020_home <- setDT(budsetPlasticity_2020)[, .SD[which.min(abs(TD))], by=Family]
budset_2020_away <- setDT(budsetPlasticity_2020)[, .SD[which.max(abs(TD))], by=Family]

colnames(budset_2020_home)[colnames(budset_2020_home)=="BudSet_2020"] <- "home"
colnames(budset_2020_away)[colnames(budset_2020_away)=="BudSet_2020"] <- "away"
budsetPlasticity_2020 <- merge(x=budset_2020_home[,-c("TD","TD2")],
                               y=budset_2020_away[,c("Family","away")],
                               by="Family")

# # file for step 10
# file10_bs20 <- budsetPlasticity_2020
# file10_bs20$Trait <- "BudSet2020"
# file10_bs20 <- file10_bs20 %>% tidyr::pivot_longer(cols=c("home","away"),
#                                                            names_to = "Environment",
#                                                            values_to = "value")


budsetPlasticity_2020$BudSet2020_Plasticity <- (budsetPlasticity_2020$home - budsetPlasticity_2020$away)/budsetPlasticity_2020$home
```

**Budset 2020 v CTD**  
```{r}

budset_2020$mBed <- paste0(budset_2020$Region,"_",budset_2020$Bed)

budset_2020$Region <- factor(budset_2020$Region,levels = c("Core", "Margin", "Edge")) 

budset_2020_modTD <- lmer(BudSet ~ Garden * TD + Region + (1|Family) + (1|Population) + (1|mBed), data=budset_2020)


# trait vs TD
budset2020_TD <-      ggplot(data=budset_2020,
                           aes(x= TD,y=BudSet, color=Region)) + 
                            geom_point(aes(shape = Region), size=2, alpha = 0.2) + 
                              geom_smooth(method='lm', se=F, formula=y~x) + # formula=y~poly(x,2))
                                scale_color_manual(values = c("Core" = "goldenrod2","Margin"="green2", "Edge"="steelblue")) +
                                  labs(x = "Climate Transfer Distance", 
                                       y = "Bud set in 2020 (DOY)") + 
                                    theme_bw() + theme(axis.text=element_text(size=18), 
                                         axis.title=element_text(size=20),#face="bold"),
                                         legend.title = element_text(color = "black", size = 22),
                                         legend.text = element_text(color = "black", size = 22)) + 
                      guides(color = guide_legend(override.aes = list(size = 8)))
```

## Bud break 2020  
```{r}
budbreak_2020$gMAT <- NA # garden MAT
budbreak_2020[budbreak_2020$Garden=="Vermont","gMAT"] <- Garden_MAT_2020[Garden_MAT_2020$Garden=="VT_coords","MAT"]
budbreak_2020[budbreak_2020$Garden=="Maryland","gMAT"] <- Garden_MAT_2020[Garden_MAT_2020$Garden=="MD_coords","MAT"]
budbreak_2020[budbreak_2020$Garden=="North_Carolina","gMAT"] <- Garden_MAT_2020[Garden_MAT_2020$Garden=="NC_coords","MAT"]

budbreak_2020 <- merge(x=budbreak_2020,
                     y=Provenance_MAT[,c("site","MAT")],
                     by.x="Population",
                     by.y="site")

colnames(budbreak_2020)[colnames(budbreak_2020)=="MAT"] <- "pMAT"
budbreak_2020$TD <- budbreak_2020$gMAT - budbreak_2020$pMAT
budbreak_2020$TD2 <- budbreak_2020$TD*budbreak_2020$TD # to check for the quadreatic relationship between transfer distance and response variable

# family_garden column
budbreak_2020 <- budbreak_2020 %>% unite(Family_gardenID, Family, Garden, sep = "_", remove = FALSE)
# budbreak_2020 <- budbreak_2020 %>% unite(Pop_gardenID, Population, Garden, sep = "_", remove = FALSE)

# per site
budbreak_2020_VT <- budbreak_2020 %>% filter(Garden == "Vermont")
budbreak_2020_MD <- budbreak_2020 %>% filter(Garden == "Maryland")
budbreak_2020_NC <- budbreak_2020 %>% filter(Garden == "North_Carolina")

# Vemont
bb_2020_VT <- lmer(cGDD ~ 1 + (1|Bed) + (1|Family), budbreak_2020_VT,na.action=na.omit)
bb_2020_VT <- coef(bb_2020_VT)
bb_2020_VT <- bb_2020_VT$Family
bb_2020_VT <- cbind(Family=rownames(bb_2020_VT),bb_2020_VT)
rownames(bb_2020_VT) <- NULL

# Maryland
bb_2020_MD <- lmer(cGDD ~ 1 + (1|Bed) + (1|Family), budbreak_2020_MD,na.action=na.omit)
bb_2020_MD <- coef(bb_2020_MD)
bb_2020_MD <- bb_2020_MD$Family
bb_2020_MD <- cbind(Family=rownames(bb_2020_MD),bb_2020_MD)
rownames(bb_2020_MD) <- NULL

# North Carolina
bb_2020_NC <- lmer(cGDD ~ 1 + (1|Bed) + (1|Family), budbreak_2020_NC,na.action=na.omit)
bb_2020_NC <- coef(bb_2020_NC)
bb_2020_NC <- bb_2020_NC$Family
bb_2020_NC <- cbind(Family=rownames(bb_2020_NC),bb_2020_NC)
rownames(bb_2020_NC) <- NULL

# large no .of families missing at the NC site, remove the excess families from other sites
bb_2020_VT <- bb_2020_VT[(bb_2020_VT$Family %in% bb_2020_NC$Family),]; nrow(bb_2020_VT[(bb_2020_VT$Family %in% bb_2020_MD$Family),])
bb_2020_MD <- bb_2020_MD[(bb_2020_MD$Family %in% bb_2020_NC$Family),]

# add garden column
bb_2020_VT$Garden <- "Vermont"
bb_2020_MD$Garden <- "Maryland"
bb_2020_NC$Garden <- "North_Carolina"

bb_2020_VT <- bb_2020_VT %>% unite(Family_gardenID, Family, Garden, sep = "_", remove = FALSE)
bb_2020_MD <- bb_2020_MD %>% unite(Family_gardenID, Family, Garden, sep = "_", remove = FALSE)
bb_2020_NC <- bb_2020_NC %>% unite(Family_gardenID, Family, Garden, sep = "_", remove = FALSE)

# combine family level data
budbreakPlasticity_2020 <- rbind(bb_2020_VT,bb_2020_MD,bb_2020_NC)
colnames(budbreakPlasticity_2020)[colnames(budbreakPlasticity_2020)=="(Intercept)"] <- "BudBreak_2020"

# add transfer distance
budbreakPlasticity_2020 <- merge(x=budbreakPlasticity_2020,
                                y=budbreak_2020[,c("Family_gardenID","TD","TD2")],
                                by="Family_gardenID")
```


```{r}
# trait vs TD
ggplot(data=budbreak_2020,
         aes(x= TD,y=cGDD)) + 
          geom_point() + 
            geom_smooth(method='lm', se=F, formula=y~poly(x,2))


```

**Budbreak 2020 v CTD**  
```{r}
budbreak_2020$Region <- factor(budbreak_2020$Region,levels = c("Core", "Margin", "Edge")) 
budbreak_2020 <- budbreak_2020 %>% unite(mBed, Garden, Bed, sep = "_", remove = FALSE)
  
budbreak_2020_modTD <- lmer(cGDD ~ Garden * TD + Region + (1|Family) + (1|Population) + (1|mBed),
                            data=budbreak_2020, na.action = na.exclude)


# trait vs TD
budbreak2020_TD <-   ggplot(data=budbreak_2020,
                         aes(x= TD,y=cGDD, color=Region)) + 
                          geom_point(aes(shape = Region), size=2, alpha = 0.1) + 
                            geom_smooth(method='lm', se=F, formula=y~x) + # formula=y~poly(x,2))
                              scale_color_manual(values = c("Core" = "goldenrod2","Edge"="steelblue","Margin"="green2")) +
                                labs(x = "", 
                                     y = "Bud break in 2020 (cGDD)") + 
                                  theme_bw() + theme(axis.text=element_text(size=18), 
                                       axis.title=element_text(size=20), #face="bold"),
                                       legend.title = element_text(color = "black", size = 23),
                                       legend.text = element_text(color = "black", size = 23)) 




```


```{r}
budbreakPlasticity_2020 <- as.data.table(budbreakPlasticity_2020)
budbreak_2020_home <- setDT(budbreakPlasticity_2020)[, .SD[which.min(abs(TD))], by=Family]
budbreak_2020_away <- setDT(budbreakPlasticity_2020)[, .SD[which.max(abs(TD))], by=Family]

colnames(budbreak_2020_home)[colnames(budbreak_2020_home)=="BudBreak_2020"] <- "home"
colnames(budbreak_2020_away)[colnames(budbreak_2020_away)=="BudBreak_2020"] <- "away"
budbreakPlasticity_2020 <- merge(x=budbreak_2020_home[,-c("TD","TD2")],
                               y=budbreak_2020_away[,c("Family","away")],
                               by="Family")

# # file for step 10
# file10_bb20 <- budbreakPlasticity_2020
# file10_bb20$Trait <- "BudBreak2020"
# file10_bb20 <- file10_bb20 %>% tidyr::pivot_longer(cols=c("home","away"),
#                                                            names_to = "Environment",
#                                                            values_to = "value")


budbreakPlasticity_2020$BudBreak2020_Plasticity <- (budbreakPlasticity_2020$home - budbreakPlasticity_2020$away)/budbreakPlasticity_2020$home
```



# Plasticity_TD  
```{r}
Plasticity_TD <- merge(x=Plasticity[,c(2:10)],y=budsetPlasticity_2019[,c("Family","BudSet2019_Plasticity")],by="Family",all.x=T)
Plasticity_TD <- merge(x=Plasticity_TD,y=budsetPlasticity_2020[,c("Family","BudSet2020_Plasticity")],by="Family",all.x=T)
Plasticity_TD <- merge(x=Plasticity_TD,y=budbreakPlasticity_2020[,c("Family","BudBreak2020_Plasticity")],by="Family",all.x=T)


# write.csv(Plasticity_TD, "./trait_data/Plasticity_TD.csv")
```


**File for Step 10 - Home vs Away  
```{r}

# file10 <- rbind(file10_bs19,file10_bs20,file10_bb20,file10_gw19,file10_gw20)
# 
# write.csv(file10, "./trait_data/Home_vs_Away.csv")

```

# Trait vs Climate Transfer Distance  {.tabset .tabset-fade .tabset-pills}
## Budset 2019  
```{r}
budset2019_TD

# budset_2019_modTD <- lmer(BudSet ~ Garden * TD + Region + (1|Family) + (1|Population) + (1|mBed), data=budset_2019)
summary(budset_2019_modTD)
```

## Budset 2020  
```{r}
budset2020_TD

# budset_2020_modTD <- lmer(BudSet ~ Garden * TD + Region + (1|Family) + (1|Population) + (1|mBed), data=budset_2020)
summary(budset_2020_modTD)
```

## Budbreak 2020  
```{r}
budbreak2020_TD
  
# budbreak_2020_modTD <- lmer(cGDD ~ Garden * TD + Region + (1|Family) + (1|Population) + (1|mBed), data=budbreak_2020, na.action = na.exclude)
summary(budbreak_2020_modTD)

# Model plot reflecting the outputs of the ggplot figure 
sjPlot::plot_model(budbreak_2020_modTD, type = "slope") +
                                theme_bw() + theme(axis.text=element_text(size=14), 
                                                 axis.title=element_text(size=18),
                                                 legend.position = "bottom",
                                                 plot.background = element_blank(),
                                                 panel.grid.major = element_blank(),
                                                 panel.grid.minor = element_blank(),
                                                 panel.background = element_blank(),
                                                 plot.title = element_blank()) 
```

## Combined  
```{r}
legend <- get_legend(budset2020_TD + theme(legend.position="right"))


TD_grid <- plot_grid( budset2019_TD + theme(legend.position="none"),
           budset2020_TD + theme(legend.position="none"),
           budbreak2020_TD + theme(legend.position="none"),
           align = 'vh',
           labels = c("A", "B", "C"),
           hjust = -1,
           nrow = 1
           )
# combined plot 
plot_grid(TD_grid, legend, ncol = 2, rel_widths = c(1,.10))
```

