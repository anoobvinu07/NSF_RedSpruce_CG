---
title: "Genetic correlations"
author: "Anoob Prakash"
date: "02/02/2021"
output:
  rmarkdown::html_document:
    theme: cosmo  
    number_sections: false
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Methods  
**lmer model**  
- Mixed effect model run to get the family level blups for use in the MCMC run.  
- Garden is set as the fixed effect.  
- Family and mBed (5 beds x 3 sites) set as random effect.  
```
trait1 <- trait1 %>% unite(mBed, Garden, Bed, sep = "_", remove = FALSE)
trait1 <- lmer(Growth ~ Garden + (1|mBed) + (1|Family), trait1)
trait1 <- ranef(trait1)
trait1 <- trait1$Family
trait1 <- cbind(Family=rownames(trait1),trait1)
rownames(trait1) <- NULL
names(trait1)[2] <- "Growth"
trait1$Population <- gsub("\\_.*", "", trait1$Family)
```

**MCMC model** 
- The scaled family blups of the traits are used as input MCMC run.  
- Random effect of Population accounted for in this model  
```
trait1_trait2_fam_blup_pop_corr <- MCMCglmm(cbind(scale(trait1),scale(trait2)) ~ trait - 1, 
                                            random=~us(trait):Population,
                                            rcov=~us(trait):units, # or idh
                                            family=c("gaussian","gaussian"),
                                            prior=prior_corr, 
                                            # pedigree=Ped, 
                                            data=bs_19_gw_19,
                                            pr=TRUE, 
                                            verbose=TRUE,
                                            nitt=10000000, 
                                            burnin=10000, 
                                            thin=1000)
```

## notes  
gw - growth  
bb - budbreak  
bs - budset  
B - lmer family blups (means)  
P - plasticity value for the trait  

- notes from: https://stat.ethz.ch/pipermail/r-sig-mixed-models/2017q1/025532.html  
- multiresponse mcmc models, page 92: https://cran.r-project.org/web/packages/MCMCglmm/vignettes/CourseNotes.pdf  

## packages  
```{r}
require(MCMCglmm)
require(lmerTest)
require(dplyr)
require(tidyr)
require(plotly)
require(plyr)
require(viridis)
# require(grid)
# require(gridExtra)

# setwd("Z:/Anoob/MCMCglmm")
```

## data  
```{r}
# exome data
exome_meta <- read.table("./Exome/RS_Exome_metadata.txt", sep="\t", header = T)

# climateNA
climateNA <- read.csv("./ClimateNA/Family/PCA_sprucePops.txt",
                                 header=T, sep="\t")
colnames(climateNA)[colnames(climateNA)=="PC1_sel"] <- "PC1"

Population_climateNA <- read.csv("./ClimateNA/Family/PCA_sprucePops.txt",
                                 header=T, sep="\t")
colnames(Population_climateNA)[colnames(Population_climateNA)=="PC1_sel"] <- "PC1"

Family_climateNA <- read.csv("./ClimateNA/Family/PCA_spruceFams.txt",
                                 header=T, sep="\t")
colnames(Family_climateNA)[colnames(Family_climateNA)=="PC1_sel"] <- "PC1"

# data 
budset_19 <- read.csv("./trait_data/BudSet_2019.csv")
budset_20 <- read.csv("./trait_data/BudSet_2020.csv")
budbreak_20 <- read.csv("./trait_data/BudBreak_2020_cGDD.csv")
heightGrowth_19 <- read.csv("./trait_data/Growth_2019.csv")
heightGrowth_20 <- read.csv("./trait_data/Growth_2020.csv")
```

## Family blups  
```{r}
## family blups
# blups for budset 2019
budset_19 <- budset_19 %>% unite(mBed, Garden, Bed, sep = "_", remove = FALSE)
budset_19 <- lmer(BudSet ~ Garden + (1|mBed) + (1|Family), budset_19)
budset_19 <- ranef(budset_19)
budset_19 <- budset_19$Family
budset_19 <- cbind(Family=rownames(budset_19),budset_19)
rownames(budset_19) <- NULL
names(budset_19)[2] <- "BudSet"
budset_19$Population <- gsub("\\_.*", "", budset_19$Family)

# blups for budset 2020
budset_20 <- budset_20 %>% unite(mBed, Garden, Bed, sep = "_", remove = FALSE)
budset_20 <- lmer(BudSet ~ Garden + (1|mBed) + (1|Family), budset_20)
budset_20 <- ranef(budset_20)
budset_20 <- budset_20$Family
budset_20 <- cbind(Family=rownames(budset_20),budset_20)
rownames(budset_20) <- NULL
names(budset_20)[2] <- "BudSet"
budset_20$Population <- gsub("\\_.*", "", budset_20$Family)

# blups for budbreak 2020
budbreak_20 <- budbreak_20 %>% unite(mBed, Garden, Bed, sep = "_", remove = FALSE)
budbreak_20 <- lmer(cGDD ~ Garden + (1|mBed) + (1|Family), budbreak_20, na.action = na.exclude)
budbreak_20 <- ranef(budbreak_20)
budbreak_20 <- budbreak_20$Family
budbreak_20 <- cbind(Family=rownames(budbreak_20),budbreak_20)
rownames(budbreak_20) <- NULL
names(budbreak_20)[2] <- "cGDD"
budbreak_20$Population <- gsub("\\_.*", "", budbreak_20$Family)

# blups for height growth 2019
heightGrowth_19 <- heightGrowth_19 %>% unite(mBed, Garden, Bed, sep = "_", remove = FALSE)
heightGrowth_19 <- lmer(Growth ~ Garden + (1|mBed) + (1|Family), heightGrowth_19)
heightGrowth_19 <- ranef(heightGrowth_19)
heightGrowth_19 <- heightGrowth_19$Family
heightGrowth_19 <- cbind(Family=rownames(heightGrowth_19),heightGrowth_19)
rownames(heightGrowth_19) <- NULL
names(heightGrowth_19)[2] <- "Growth"
heightGrowth_19$Population <- gsub("\\_.*", "", heightGrowth_19$Family)

# blups for height growth 2020
heightGrowth_20 <- heightGrowth_20 %>% unite(mBed, Garden, Bed, sep = "_", remove = FALSE)
heightGrowth_20 <- lmer(Growth ~ Garden + (1|mBed) + (1|Family), heightGrowth_20)
heightGrowth_20 <- ranef(heightGrowth_20)
heightGrowth_20 <- heightGrowth_20$Family
heightGrowth_20 <- cbind(Family=rownames(heightGrowth_20),heightGrowth_20)
rownames(heightGrowth_20) <- NULL
names(heightGrowth_20)[2] <- "Growth"
heightGrowth_20$Population <- gsub("\\_.*", "", heightGrowth_20$Family)
```




# Phenology vs growth  
## Budset 2019-Growth 2019 {.tabset .tabset-fade .tabset-pills}  

### Summary  
```{r}
# against current year
bs_19_gw_19_fam_blup_pop_corr <- readRDS("./genetic_correlation_outputs/bs_19_gw_19_fam_blup_pop_corr")

summary(bs_19_gw_19_fam_blup_pop_corr)
effectiveSize(bs_19_gw_19_fam_blup_pop_corr$VCV)
heidel.diag(bs_19_gw_19_fam_blup_pop_corr$VCV)
```

```{r}
head(bs_19_gw_19_fam_blup_pop_corr$VCV)
# genetic correlation
bs_19_gw_19_pop_gencorr <- bs_19_gw_19_fam_blup_pop_corr$VCV[,"traitBudSet:traitGrowth.Population"]/sqrt(bs_19_gw_19_fam_blup_pop_corr$VCV[,"traitBudSet:traitBudSet.Population"] * bs_19_gw_19_fam_blup_pop_corr$VCV[,"traitGrowth:traitGrowth.Population"])

posterior.mode(bs_19_gw_19_pop_gencorr)
HPDinterval(bs_19_gw_19_pop_gencorr)
```

### Data  

**MCMC**  

```{r}
## setting up dataframe for correlation based on the model blups
bs_19_gw_19_coefs <- data_frame(Trait = attr(colMeans(bs_19_gw_19_fam_blup_pop_corr$Sol), "names"),
                                    Value = colMeans(bs_19_gw_19_fam_blup_pop_corr$Sol)) %>%
  separate(Trait, c("Trait","Type","Population"), sep = "\\.", fill = "right") %>%
  filter(Type == "Population") %>%
  filter(Trait %in% c("traitGrowth", "traitBudSet")) %>%
  select(-Type) %>%
  spread(Trait, Value)


bs_19_gw_19_coefs <- merge(x=bs_19_gw_19_coefs,
                              y=exome_meta[,c("Pop","Region")],
                              all.x=T,
                              by.x="Population",
                              by.y="Pop")

# rename regions
bs_19_gw_19_coefs$Region <- revalue(bs_19_gw_19_coefs$Region, c("C"="Core", "M"="Margin","E"="Edge")) 
# reorder regions
bs_19_gw_19_coefs$Region <- factor(bs_19_gw_19_coefs$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
bs_19_gw_19_coefs <- merge(x=bs_19_gw_19_coefs,
                           y=Population_climateNA[,c("Population","PC1","MAT")],
                           by="Population")

cor.test(bs_19_gw_19_coefs$traitBudSet,bs_19_gw_19_coefs$traitGrowth) #0.6867328
```

**Family**  

```{r}
bs_19_gw_19 <- merge(budset_19,heightGrowth_19[,c("Family","Growth")])
bs_19_gw_19 <- bs_19_gw_19[!is.na(bs_19_gw_19$BudSet),]
bs_19_gw_19 <- bs_19_gw_19[!is.na(bs_19_gw_19$Growth),]

# merge Region data
bs_19_gw_19 <- merge(x=bs_19_gw_19,
                               y=exome_meta[,c("Pop","Region")],
                               by.x="Population",
                               by.y="Pop")

# rename and  reorder regions
bs_19_gw_19$Region <- plyr::revalue(bs_19_gw_19$Region,
                               c("C" = "Core",
                                 "M" = "Margin",
                                 "E" = "Edge"))
bs_19_gw_19$Region <- factor(bs_19_gw_19$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
bs_19_gw_19 <- merge(x=bs_19_gw_19,
                               y=Family_climateNA[,c("Population","PC1","MAT")],
                               by="Population")
bs_19_gw_19 <- distinct(bs_19_gw_19)
```

**Population**   
```{r}
bs_19_gw_19$Population <- as.factor(bs_19_gw_19$Population)

bs_19_gw_19_pop <- bs_19_gw_19 %>%
                            select(Population, BudSet, Growth, Region) %>%
                            group_by(Population) %>%
                            dplyr::summarise(BudSet = mean(BudSet), Growth = mean(Growth))

bs_19_gw_19_pop <- merge(x=bs_19_gw_19_pop,
                               y=Population_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

bs_19_gw_19_pop <- merge(x=bs_19_gw_19_pop,
                               y=exome_meta[,c("Pop","Region")],
                               by.x="Population",
                               by.y="Pop")
# rename and  reorder regions
bs_19_gw_19_pop$Region <- plyr::revalue(bs_19_gw_19_pop$Region,
                               c("C" = "Core",
                                 "M" = "Margin",
                                 "E" = "Edge"))
bs_19_gw_19_pop$Region <- factor(bs_19_gw_19_pop$Region,levels = c("Core", "Margin", "Edge"))

bs_19_gw_19_pop <- distinct(bs_19_gw_19_pop)
```

### MCMC plot  
```{r}
# plot
ggplot(bs_19_gw_19_coefs, aes(x = traitBudSet, y = traitGrowth, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  # geom_abline(intercept = 0, slope = mean(gw_19_B_gw_19_P_fit_slope)) + 
  labs(x = "Budset in 2019", y = "Height Growth in 2019") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) #+
  # annotate("text", label = "Correlation between traits: 0.688", x = 0.7, y = -1.2)
```

### Family plot   
```{r}
# plot
ggplot(bs_19_gw_19, aes(x = BudSet, y = Growth, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  # geom_abline(intercept = 0, slope = mean(gw_19_B_gw_19_P_fit_slope)) + 
  labs(x = "Budset in 2019", y = "Height Growth in 2019") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) #+
  # annotate("text", label = "Correlation between traits: 0.688", x = 0.7, y = -1.2)
```

### Population plot   
```{r}
# plot
ggplot(bs_19_gw_19_pop, aes(x = BudSet, y = Growth, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  # geom_abline(intercept = 0, slope = mean(gw_19_B_gw_19_P_fit_slope)) + 
  labs(x = "Budset in 2019", y = "Height Growth in 2019") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) #+
  # annotate("text", label = "Correlation between traits: 0.688", x = 0.7, y = -1.2)
```

## Budset 2020-Growth 2020 {.tabset .tabset-fade .tabset-pills}  
### Summary  
```{r}
# against current year
bs_20_gw_20_fam_blup_pop_corr <- readRDS("./genetic_correlation_outputs/bs_20_gw_20_fam_blup_pop_corr")

summary(bs_20_gw_20_fam_blup_pop_corr)
effectiveSize(bs_20_gw_20_fam_blup_pop_corr$VCV)
heidel.diag(bs_20_gw_20_fam_blup_pop_corr$VCV)
```

```{r}
head(bs_20_gw_20_fam_blup_pop_corr$VCV)
# genetic correlation
bs_20_gw_20_pop_gencorr <- bs_20_gw_20_fam_blup_pop_corr$VCV[,"traitBudSet:traitGrowth.Population"]/sqrt(bs_20_gw_20_fam_blup_pop_corr$VCV[,"traitBudSet:traitBudSet.Population"] * bs_20_gw_20_fam_blup_pop_corr$VCV[,"traitGrowth:traitGrowth.Population"])

posterior.mode(bs_20_gw_20_pop_gencorr)
HPDinterval(bs_20_gw_20_pop_gencorr)
```

### Data  

**MCMC**  

```{r}
## setting up dataframe for correlation based on the model blups
bs_20_gw_20_coefs <- data_frame(Trait = attr(colMeans(bs_20_gw_20_fam_blup_pop_corr$Sol), "names"),
                                Value = colMeans(bs_20_gw_20_fam_blup_pop_corr$Sol)) %>%
  separate(Trait, c("Trait","Type","Population"), sep = "\\.", fill = "right") %>%
  filter(Type == "Population") %>%
  filter(Trait %in% c("traitGrowth", "traitBudSet")) %>%
  select(-Type) %>%
  spread(Trait, Value)


bs_20_gw_20_coefs <- merge(x=bs_20_gw_20_coefs,
                           y=exome_meta[,c("Pop","Region")],
                           all.x=T,
                           by.x="Population",
                           by.y="Pop")

# rename regions
bs_20_gw_20_coefs$Region <- revalue(bs_20_gw_20_coefs$Region, c("C"="Core", "M"="Margin","E"="Edge")) 
# reorder regions
bs_20_gw_20_coefs$Region <- factor(bs_20_gw_20_coefs$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
bs_20_gw_20_coefs <- merge(x=bs_20_gw_20_coefs,
                           y=Population_climateNA[,c("Population","PC1","MAT")],
                           by="Population")

cor.test(bs_20_gw_20_coefs$traitBudSet,bs_20_gw_20_coefs$traitGrowth) #0.9357684
```

**Family**  

```{r}
# against current year
bs_20_gw_20 <- merge(budset_20,heightGrowth_20[,c("Family","Growth")])
bs_20_gw_20 <- bs_20_gw_20[!is.na(bs_20_gw_20$BudSet),]
bs_20_gw_20 <- bs_20_gw_20[!is.na(bs_20_gw_20$Growth),]

# merge Region data
bs_20_gw_20 <- merge(x=bs_20_gw_20,
                               y=exome_meta[,c("Pop","Region")],
                               by.x="Population",
                               by.y="Pop")

# rename and  reorder regions
bs_20_gw_20$Region <- plyr::revalue(bs_20_gw_20$Region,
                               c("C" = "Core",
                                 "M" = "Margin",
                                 "E" = "Edge"))
bs_20_gw_20$Region <- factor(bs_20_gw_20$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
bs_20_gw_20 <- merge(x=bs_20_gw_20,
                               y=Family_climateNA[,c("Population","PC1","MAT")],
                               by="Population")
bs_20_gw_20 <- distinct(bs_20_gw_20)
```

**Population**   
```{r}
bs_20_gw_20$Population <- as.factor(bs_20_gw_20$Population)

bs_20_gw_20_pop <- bs_20_gw_20 %>%
                            select(Population, BudSet, Growth, Region) %>%
                            group_by(Population) %>%
                            dplyr::summarise(BudSet = mean(BudSet), Growth = mean(Growth))

bs_20_gw_20_pop <- merge(x=bs_20_gw_20_pop,
                               y=Population_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

bs_20_gw_20_pop <- merge(x=bs_20_gw_20_pop,
                               y=exome_meta[,c("Pop","Region")],
                               by.x="Population",
                               by.y="Pop")
# rename and  reorder regions
bs_20_gw_20_pop$Region <- plyr::revalue(bs_20_gw_20_pop$Region,
                               c("C" = "Core",
                                 "M" = "Margin",
                                 "E" = "Edge"))
bs_20_gw_20_pop$Region <- factor(bs_20_gw_20_pop$Region,levels = c("Core", "Margin", "Edge"))

bs_20_gw_20_pop <- distinct(bs_20_gw_20_pop)
```

### MCMC plot  

```{r}
# plot
bs_20_gw_20_PC1 <- ggplot(bs_20_gw_20_coefs, aes(x = traitBudSet, y = traitGrowth, group = Population, color = PC1)) +
                    geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
                    scale_color_viridis(option = "A", direction = -1) +
                    # geom_abline(intercept = 0, slope = mean(gw_19_B_gw_19_P_fit_slope)) + 
                    labs(x = "Budset in 2020", y = "Height Growth in 2020") + 
                    theme_bw() + theme(axis.text=element_text(size=14), 
                                       axis.title=element_text(size=14,face="bold"),
                                       legend.title = element_text(color = "black", size = 14),
                                       legend.text = element_text(color = "black", size = 13)) #+
                    # annotate("text", label = "Correlation between traits: 0.936", x = 1.5, y = -0.9)  
bs_20_gw_20_PC1
# ggplotly(bs_20_gw_20_PC1)


```

### Family plot  

```{r}
# plot
ggplot(bs_20_gw_20, aes(x = BudSet, y = Growth, group = Population, color = PC1)) +
                    geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
                    scale_color_viridis(option = "A", direction = -1) +
                    # geom_abline(intercept = 0, slope = mean(gw_19_B_gw_19_P_fit_slope)) + 
                    labs(x = "Budset in 2020", y = "Height Growth in 2020") + 
                    theme_bw() + theme(axis.text=element_text(size=14), 
                                       axis.title=element_text(size=14,face="bold"),
                                       legend.title = element_text(color = "black", size = 14),
                                       legend.text = element_text(color = "black", size = 13)) #+
                    annotate("text", label = "Correlation between traits: 0.936", x = 1.5, y = -0.9)  

# ggplotly(bs_20_gw_20_PC1)


```

### Population plot  

```{r}
# plot
ggplot(bs_20_gw_20_pop, aes(x = BudSet, y = Growth, group = Population, color = PC1)) +
                    geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
                    scale_color_viridis(option = "A", direction = -1) +
                    # geom_abline(intercept = 0, slope = mean(gw_19_B_gw_19_P_fit_slope)) + 
                    labs(x = "Budset in 2020", y = "Height Growth in 2020") + 
                    theme_bw() + theme(axis.text=element_text(size=14), 
                                       axis.title=element_text(size=14,face="bold"),
                                       legend.title = element_text(color = "black", size = 14),
                                       legend.text = element_text(color = "black", size = 13))
```

## Budbreak 2020-Growth 2019  {.tabset .tabset-fade .tabset-pills}  

### Summary  
```{r}
# against previous year
bb_20_gw_19_fam_blup_pop_corr <- readRDS("./genetic_correlation_outputs/bb_20_gw_19_fam_blup_pop_corr")

summary(bb_20_gw_19_fam_blup_pop_corr)
effectiveSize(bb_20_gw_19_fam_blup_pop_corr$VCV)
heidel.diag(bb_20_gw_19_fam_blup_pop_corr$VCV)
```

```{r}
head(bb_20_gw_19_fam_blup_pop_corr$VCV)
# genetic correlation
bb_20_gw_19_pop_gencorr <- bb_20_gw_19_fam_blup_pop_corr$VCV[,"traitcGDD:traitGrowth.Population"]/sqrt(bb_20_gw_19_fam_blup_pop_corr$VCV[,"traitcGDD:traitcGDD.Population"] * bb_20_gw_19_fam_blup_pop_corr$VCV[,"traitGrowth:traitGrowth.Population"])

posterior.mode(bb_20_gw_19_pop_gencorr)
HPDinterval(bb_20_gw_19_pop_gencorr)
```

### Data  
**MCMC**  
```{r}
## setting up dataframe for correlation based on the model blups
bb_20_gw_19_coefs <- data_frame(Trait = attr(colMeans(bb_20_gw_19_fam_blup_pop_corr$Sol), "names"),
                                Value = colMeans(bb_20_gw_19_fam_blup_pop_corr$Sol)) %>%
  separate(Trait, c("Trait","Type","Population"), sep = "\\.", fill = "right") %>%
  filter(Type == "Population") %>%
  filter(Trait %in% c("traitGrowth", "traitcGDD")) %>%
  select(-Type) %>%
  spread(Trait, Value)


bb_20_gw_19_coefs <- merge(x=bb_20_gw_19_coefs,
                           y=exome_meta[,c("Pop","Region")],
                           all.x=T,
                           by.x="Population",
                           by.y="Pop")

# rename regions
bb_20_gw_19_coefs$Region <- revalue(bb_20_gw_19_coefs$Region, c("C"="Core", "M"="Margin","E"="Edge")) 
# reorder regions
bb_20_gw_19_coefs$Region <- factor(bb_20_gw_19_coefs$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
bb_20_gw_19_coefs <- merge(x=bb_20_gw_19_coefs,
                           y=Population_climateNA[,c("Population","PC1","MAT")],
                           by="Population")

cor.test(bb_20_gw_19_coefs$traitcGDD,bb_20_gw_19_coefs$traitGrowth) #0.6323891
```

**Family**  
```{r}
# against previous year
bb_20_gw_19 <- merge(budbreak_20,heightGrowth_19[,c("Family","Growth")])
bb_20_gw_19 <- bb_20_gw_19[!is.na(bb_20_gw_19$cGDD),]
bb_20_gw_19 <- bb_20_gw_19[!is.na(bb_20_gw_19$Growth),]

# merge Region data
bb_20_gw_19 <- merge(x=bb_20_gw_19,
                               y=exome_meta[,c("Pop","Region")],
                               by.x="Population",
                               by.y="Pop")

# rename and  reorder regions
bb_20_gw_19$Region <- plyr::revalue(bb_20_gw_19$Region,
                               c("C" = "Core",
                                 "M" = "Margin",
                                 "E" = "Edge"))
bb_20_gw_19$Region <- factor(bb_20_gw_19$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
bb_20_gw_19 <- merge(x=bb_20_gw_19,
                               y=Family_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

bb_20_gw_19 <- distinct(bb_20_gw_19)
```

**Population**   
```{r}
bb_20_gw_19$Population <- as.factor(bb_20_gw_19$Population)

bb_20_gw_19_pop <- bb_20_gw_19 %>%
                            select(Population, cGDD, Growth, Region) %>%
                            group_by(Population) %>%
                            dplyr::summarise(cGDD = mean(cGDD), Growth = mean(Growth))

bb_20_gw_19_pop <- merge(x=bb_20_gw_19_pop,
                               y=Population_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

bb_20_gw_19_pop <- merge(x=bb_20_gw_19_pop,
                               y=exome_meta[,c("Pop","Region")],
                               by.x="Population",
                               by.y="Pop")
# rename and  reorder regions
bb_20_gw_19_pop$Region <- plyr::revalue(bb_20_gw_19_pop$Region,
                               c("C" = "Core",
                                 "M" = "Margin",
                                 "E" = "Edge"))
bb_20_gw_19_pop$Region <- factor(bb_20_gw_19_pop$Region,levels = c("Core", "Margin", "Edge"))

bb_20_gw_19_pop <- distinct(bb_20_gw_19_pop)
```

### MCMC plot  
```{r}
# plot
ggplot(bb_20_gw_19_coefs, aes(x = traitcGDD, y = traitGrowth, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Budbreak in 2020", y = "Height Growth in 2019") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) #+
  # annotate("text", label = "Correlation between traits: 0.63", x = 0.632, y = -1.4)  
```

### Family plot  
```{r}
# plot
ggplot(bb_20_gw_19, aes(x = Growth, y = cGDD, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Height Growth in 2019", y = "Budbreak in 2020") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) #+
  # annotate("text", label = "Correlation between traits: 0.63", x = 0.632, y = -1.4)  
```

### Population plot  
```{r}
# plot
ggplot(bb_20_gw_19_pop, aes(x = Growth, y = cGDD, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Height Growth in 2019", y = "Budbreak in 2020") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) 
```

## Budbreak 2020-Growth 2020  {.tabset .tabset-fade .tabset-pills}  
### Summary  
```{r}
# against current year
bb_20_gw_20_fam_blup_pop_corr <- readRDS("./genetic_correlation_outputs/bb_20_gw_20_fam_blup_pop_corr")

summary(bb_20_gw_20_fam_blup_pop_corr)
effectiveSize(bb_20_gw_20_fam_blup_pop_corr$VCV)
heidel.diag(bb_20_gw_20_fam_blup_pop_corr$VCV)
```

```{r}
head(bb_20_gw_20_fam_blup_pop_corr$VCV)
# genetic correlation
bb_20_gw_20_pop_gencorr <- bb_20_gw_20_fam_blup_pop_corr$VCV[,"traitcGDD:traitGrowth.Population"]/sqrt(bb_20_gw_20_fam_blup_pop_corr$VCV[,"traitcGDD:traitcGDD.Population"] * bb_20_gw_20_fam_blup_pop_corr$VCV[,"traitGrowth:traitGrowth.Population"])

posterior.mode(bb_20_gw_20_pop_gencorr)
HPDinterval(bb_20_gw_20_pop_gencorr)
```

### Data  
**MCMC**  
```{r}
## setting up dataframe for correlation based on the model blups
bb_20_gw_20_coefs <- data_frame(Trait = attr(colMeans(bb_20_gw_20_fam_blup_pop_corr$Sol), "names"),
                                Value = colMeans(bb_20_gw_20_fam_blup_pop_corr$Sol)) %>%
  separate(Trait, c("Trait","Type","Population"), sep = "\\.", fill = "right") %>%
  filter(Type == "Population") %>%
  filter(Trait %in% c("traitGrowth", "traitcGDD")) %>%
  select(-Type) %>%
  spread(Trait, Value)


bb_20_gw_20_coefs <- merge(x=bb_20_gw_20_coefs,
                           y=exome_meta[,c("Pop","Region")],
                           all.x=T,
                           by.x="Population",
                           by.y="Pop")

# rename regions
bb_20_gw_20_coefs$Region <- revalue(bb_20_gw_20_coefs$Region, c("C"="Core", "M"="Margin","E"="Edge")) 
# reorder regions
bb_20_gw_20_coefs$Region <- factor(bb_20_gw_20_coefs$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
bb_20_gw_20_coefs <- merge(x=bb_20_gw_20_coefs,
                           y=Population_climateNA[,c("Population","PC1","MAT")],
                           by="Population")

cor.test(bb_20_gw_20_coefs$traitcGDD,bb_20_gw_20_coefs$traitGrowth) #-0.2778647 
```

**Family**  
```{r}
# against current year
bb_20_gw_20 <- merge(budbreak_20,heightGrowth_20[,c("Family","Growth")])
bb_20_gw_20 <- bb_20_gw_20[!is.na(bb_20_gw_20$cGDD),]
bb_20_gw_20 <- bb_20_gw_20[!is.na(bb_20_gw_20$Growth),]

# merge Region data
bb_20_gw_20 <- merge(x=bb_20_gw_20,
                               y=exome_meta[,c("Pop","Region")],
                               by.x="Population",
                               by.y="Pop")

# rename and  reorder regions
bb_20_gw_20$Region <- plyr::revalue(bb_20_gw_20$Region,
                               c("C" = "Core",
                                 "M" = "Margin",
                                 "E" = "Edge"))
bb_20_gw_20$Region <- factor(bb_20_gw_20$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
bb_20_gw_20 <- merge(x=bb_20_gw_20,
                               y=Family_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

bb_20_gw_20 <- distinct(bb_20_gw_20)
```

**Population**   
```{r}
bb_20_gw_20$Population <- as.factor(bb_20_gw_20$Population)

bb_20_gw_20_pop <- bb_20_gw_20 %>%
                            select(Population, cGDD, Growth, Region) %>%
                            group_by(Population) %>%
                            dplyr::summarise(cGDD = mean(cGDD), Growth = mean(Growth))

bb_20_gw_20_pop <- merge(x=bb_20_gw_20_pop,
                               y=Population_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

bb_20_gw_20_pop <- merge(x=bb_20_gw_20_pop,
                               y=exome_meta[,c("Pop","Region")],
                               by.x="Population",
                               by.y="Pop")
# rename and  reorder regions
bb_20_gw_20_pop$Region <- plyr::revalue(bb_20_gw_20_pop$Region,
                               c("C" = "Core",
                                 "M" = "Margin",
                                 "E" = "Edge"))
bb_20_gw_20_pop$Region <- factor(bb_20_gw_20_pop$Region,levels = c("Core", "Margin", "Edge"))

bb_20_gw_20_pop <- distinct(bb_20_gw_20_pop)
```

### MCMC plot  

```{r}
# plot
ggplot(bb_20_gw_20_coefs, aes(x = traitcGDD, y = traitGrowth, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Budbreak in 2020", y = "Height Growth in 2020") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) #+
  # annotate("text", label = "Correlation between traits: -0.278", x = 0.7, y = -0.9)
```

### Family plot  

```{r}
# plot
ggplot(bb_20_gw_20, aes(x = cGDD, y = Growth, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Budbreak in 2020", y = "Height Growth in 2020") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) #+
  # annotate("text", label = "Correlation between traits: -0.278", x = 0.7, y = -0.9)
```

### Population plot  

```{r}
# plot
ggplot(bb_20_gw_20_pop, aes(x = cGDD, y = Growth, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Budbreak in 2020", y = "Height Growth in 2020") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) 
```

<!-- ### Combined dataset - MCMC   -->
<!-- ```{r eval=F} -->
<!-- bb_20_gw_19_coefs$Dataset <- "2019" -->
<!-- bb_20_gw_20_coefs$Dataset <- "2020" -->
<!-- budbreak_growth_comb <- rbind(bb_20_gw_19_coefs,bb_20_gw_20_coefs) -->

<!-- ggplot(budbreak_growth_comb, aes(x = traitcGDD, y = traitGrowth, group = Population, color = PC1)) + -->
<!--   geom_point(aes(shape = Region), size=3, alpha = 0.7) +  -->
<!--   scale_color_viridis(option = "A", direction = -1) + -->
<!--   labs(x = "Budbreak in cGDD", y = "Height Growth") +  -->
<!--   theme_bw() + theme(axis.text=element_text(size=14),  -->
<!--                      axis.title=element_text(size=14,face="bold"), -->
<!--                      legend.title = element_text(color = "black", size = 14), -->
<!--                      legend.text = element_text(color = "black", size = 13)) + -->
<!--   facet_grid(Dataset~.)  -->
<!-- ``` -->



# Phenology vs Phenology  
## Budbreak 2020-Budset 2019  {.tabset .tabset-fade .tabset-pills}  
### Summary  
```{r}
# against previous year
bb_20_bs_19_fam_blup_pop_corr <- readRDS("./genetic_correlation_outputs/bb_20_bs_19_fam_blup_pop_corr")

summary(bb_20_bs_19_fam_blup_pop_corr)
effectiveSize(bb_20_bs_19_fam_blup_pop_corr$VCV)
heidel.diag(bb_20_bs_19_fam_blup_pop_corr$VCV)
```

```{r}
head(bb_20_bs_19_fam_blup_pop_corr$VCV)
# genetic correlation
bb_20_bs_19_pop_gencorr <- bb_20_bs_19_fam_blup_pop_corr$VCV[,"traitcGDD:traitBudSet.Population"]/sqrt(bb_20_bs_19_fam_blup_pop_corr$VCV[,"traitcGDD:traitcGDD.Population"] * bb_20_bs_19_fam_blup_pop_corr$VCV[,"traitBudSet:traitBudSet.Population"])

posterior.mode(bb_20_bs_19_pop_gencorr)
HPDinterval(bb_20_bs_19_pop_gencorr)
```

### Data  

**MCMC**  
```{r}
## setting up dataframe for correlation based on the model blups
bb_20_bs_19_coefs <- data_frame(Trait = attr(colMeans(bb_20_bs_19_fam_blup_pop_corr$Sol), "names"),
                                Value = colMeans(bb_20_bs_19_fam_blup_pop_corr$Sol)) %>%
  separate(Trait, c("Trait","Type","Population"), sep = "\\.", fill = "right") %>%
  filter(Type == "Population") %>%
  filter(Trait %in% c("traitBudSet", "traitcGDD")) %>%
  select(-Type) %>%
  spread(Trait, Value)


bb_20_bs_19_coefs <- merge(x=bb_20_bs_19_coefs,
                           y=exome_meta[,c("Pop","Region")],
                           all.x=T,
                           by.x="Population",
                           by.y="Pop")

# rename regions
bb_20_bs_19_coefs$Region <- revalue(bb_20_bs_19_coefs$Region, c("C"="Core", "M"="Margin","E"="Edge")) 
# reorder regions
bb_20_bs_19_coefs$Region <- factor(bb_20_bs_19_coefs$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
bb_20_bs_19_coefs <- merge(x=bb_20_bs_19_coefs,
                           y=Population_climateNA[,c("Population","PC1","MAT")],
                           by="Population")

cor.test(bb_20_bs_19_coefs$traitcGDD,bb_20_bs_19_coefs$traitBudSet) #0.952888 
```

**Family**  
```{r}
# against previous year
bb_20_bs_19 <- merge(budbreak_20,budset_19[,c("Family","BudSet")])
bb_20_bs_19 <- bb_20_bs_19[!is.na(bb_20_bs_19$BudSet),]
bb_20_bs_19 <- bb_20_bs_19[!is.na(bb_20_bs_19$cGDD),]

# merge Region data
bb_20_bs_19 <- merge(x=bb_20_bs_19,
                               y=exome_meta[,c("Pop","Region")],
                               by.x="Population",
                               by.y="Pop")

# rename and  reorder regions
bb_20_bs_19$Region <- plyr::revalue(bb_20_bs_19$Region,
                               c("C" = "Core",
                                 "M" = "Margin",
                                 "E" = "Edge"))
bb_20_bs_19$Region <- factor(bb_20_bs_19$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
bb_20_bs_19 <- merge(x=bb_20_bs_19,
                               y=Family_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

bb_20_bs_19 <- distinct(bb_20_bs_19)
```

**Population**   
```{r}
bb_20_bs_19$Population <- as.factor(bb_20_bs_19$Population)

bb_20_bs_19_pop <- bb_20_bs_19 %>%
                            select(Population, cGDD, BudSet, Region) %>%
                            group_by(Population) %>%
                            dplyr::summarise(cGDD = mean(cGDD), BudSet = mean(BudSet))

bb_20_bs_19_pop <- merge(x=bb_20_bs_19_pop,
                               y=Population_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

bb_20_bs_19_pop <- merge(x=bb_20_bs_19_pop,
                               y=exome_meta[,c("Pop","Region")],
                               by.x="Population",
                               by.y="Pop")
# rename and  reorder regions
bb_20_bs_19_pop$Region <- plyr::revalue(bb_20_bs_19_pop$Region,
                               c("C" = "Core",
                                 "M" = "Margin",
                                 "E" = "Edge"))
bb_20_bs_19_pop$Region <- factor(bb_20_bs_19_pop$Region,levels = c("Core", "Margin", "Edge"))

bb_20_bs_19_pop <- distinct(bb_20_bs_19_pop)
```

### MCMC plot  
```{r}
# plot
ggplot(bb_20_bs_19_coefs, aes(x = traitcGDD, y = traitBudSet, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Budbreak in 2020", y = "Budset in 2019") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) #+
  # annotate("text", label = "Correlation between traits: 0.953", x = 0.8, y = -1.5)
```

### Family plot  
```{r}
# plot
ggplot(bb_20_bs_19, aes(x = BudSet, y = cGDD, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Budset in 2019", y = "Budbreak in 2020") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) #+
  # annotate("text", label = "Correlation between traits: 0.953", x = 0.8, y = -1.5)
```

### Population plot  
```{r}
# plot
ggplot(bb_20_bs_19_pop, aes(x = BudSet, y = cGDD, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Budset in 2019", y = "Budbreak in 2020") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) 
```

## Budbreak 2020-Budset 2020  {.tabset .tabset-fade .tabset-pills}  
### Summary  

```{r}
# against current year
bb_20_bs_20_fam_blup_pop_corr <- readRDS("./genetic_correlation_outputs/bb_20_bs_20_fam_blup_pop_corr")

summary(bb_20_bs_20_fam_blup_pop_corr)
effectiveSize(bb_20_bs_20_fam_blup_pop_corr$VCV)
heidel.diag(bb_20_bs_20_fam_blup_pop_corr$VCV)
```

```{r}
head(bb_20_bs_20_fam_blup_pop_corr$VCV)
# genetic correlation
bb_20_bs_20_pop_gencorr <- bb_20_bs_20_fam_blup_pop_corr$VCV[,"traitcGDD:traitBudSet.Population"]/sqrt(bb_20_bs_20_fam_blup_pop_corr$VCV[,"traitcGDD:traitcGDD.Population"] * bb_20_bs_20_fam_blup_pop_corr$VCV[,"traitBudSet:traitBudSet.Population"])

posterior.mode(bb_20_bs_20_pop_gencorr)
HPDinterval(bb_20_bs_20_pop_gencorr)
```

### Data  
**MCMC**  
```{r}
## setting up dataframe for correlation based on the model blups
bb_20_bs_20_coefs <- data_frame(Trait = attr(colMeans(bb_20_bs_20_fam_blup_pop_corr$Sol), "names"),
                                Value = colMeans(bb_20_bs_20_fam_blup_pop_corr$Sol)) %>%
  separate(Trait, c("Trait","Type","Population"), sep = "\\.", fill = "right") %>%
  filter(Type == "Population") %>%
  filter(Trait %in% c("traitBudSet", "traitcGDD")) %>%
  select(-Type) %>%
  spread(Trait, Value)


bb_20_bs_20_coefs <- merge(x=bb_20_bs_20_coefs,
                           y=exome_meta[,c("Pop","Region")],
                           all.x=T,
                           by.x="Population",
                           by.y="Pop")

# rename regions
bb_20_bs_20_coefs$Region <- revalue(bb_20_bs_20_coefs$Region, c("C"="Core", "M"="Margin","E"="Edge")) 
# reorder regions
bb_20_bs_20_coefs$Region <- factor(bb_20_bs_20_coefs$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
bb_20_bs_20_coefs <- merge(x=bb_20_bs_20_coefs,
                           y=Population_climateNA[,c("Population","PC1","MAT")],
                           by="Population")

cor.test(bb_20_bs_20_coefs$traitcGDD,bb_20_bs_20_coefs$traitBudSet) #0.08288131
```

**Family**  
```{r}
# against current year
bb_20_bs_20 <- merge(budbreak_20,budset_20[,c("Family","BudSet")])
bb_20_bs_20 <- bb_20_bs_20[!is.na(bb_20_bs_20$BudSet),]
bb_20_bs_20 <- bb_20_bs_20[!is.na(bb_20_bs_20$cGDD),]

# merge Region data
bb_20_bs_20 <- merge(x=bb_20_bs_20,
                               y=exome_meta[,c("Pop","Region")],
                               by.x="Population",
                               by.y="Pop")

# rename and  reorder regions
bb_20_bs_20$Region <- plyr::revalue(bb_20_bs_20$Region,
                               c("C" = "Core",
                                 "M" = "Margin",
                                 "E" = "Edge"))
bb_20_bs_20$Region <- factor(bb_20_bs_20$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
bb_20_bs_20 <- merge(x=bb_20_bs_20,
                               y=Family_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

bb_20_bs_20 <- distinct(bb_20_bs_20)
```

**Population**   
```{r}
bb_20_bs_20$Population <- as.factor(bb_20_bs_20$Population)

bb_20_bs_20_pop <- bb_20_bs_20 %>%
                            select(Population, cGDD, BudSet, Region) %>%
                            group_by(Population) %>%
                            dplyr::summarise(cGDD = mean(cGDD), BudSet = mean(BudSet))

bb_20_bs_20_pop <- merge(x=bb_20_bs_20_pop,
                               y=Population_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

bb_20_bs_20_pop <- merge(x=bb_20_bs_20_pop,
                               y=exome_meta[,c("Pop","Region")],
                               by.x="Population",
                               by.y="Pop")
# rename and  reorder regions
bb_20_bs_20_pop$Region <- plyr::revalue(bb_20_bs_20_pop$Region,
                               c("C" = "Core",
                                 "M" = "Margin",
                                 "E" = "Edge"))
bb_20_bs_20_pop$Region <- factor(bb_20_bs_20_pop$Region,levels = c("Core", "Margin", "Edge"))

bb_20_bs_20_pop <- distinct(bb_20_bs_20_pop)
```

### MCMC plot  
```{r}
# plot
ggplot(bb_20_bs_20_coefs, aes(x = traitcGDD, y = traitBudSet, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Budbreak in 2020", y = "Budset in 2020") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) #+
  # annotate("text", label = "Correlation between traits: 0.083", x = 0.8, y = -0.9)
```

### Family plot  
```{r}
# plot
ggplot(bb_20_bs_20, aes(x = cGDD, y = BudSet, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Budbreak in 2020", y = "Budset in 2020") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) #+
  # annotate("text", label = "Correlation between traits: 0.083", x = 0.8, y = -0.9)
```

### Population plot  
```{r}
# plot
ggplot(bb_20_bs_20_pop, aes(x = cGDD, y = BudSet, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Budbreak in 2020", y = "Budset in 2020") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) 
```

<!-- ## Combined data - old file names   -->
<!-- ```{r eval = F} -->
<!-- bb_20_bs_19_coefs$Dataset <- "2019" -->
<!-- bb_20_bs_20_coefs$Dataset <- "2020" -->
<!-- budbreak_budset_comb <- rbind(bb_20_bs_19_coefs,bb_20_bs_20_coefs) -->


<!-- ggplot(budbreak_budset_comb, aes(x = traitcGDD, y = traitBudSet, group = Population, color = MAT)) + -->
<!--   geom_point(aes(shape = Region), size=3, alpha = 0.7) +  -->
<!--   scale_color_viridis(option = "A", direction = -1) + -->
<!--   labs(x = "Budbreak in cGDD", y = "Budset in DOY") +  -->
<!--   theme_bw() + theme(axis.text=element_text(size=14),  -->
<!--                      axis.title=element_text(size=14,face="bold"), -->
<!--                      legend.title = element_text(color = "black", size = 14), -->
<!--                      legend.text = element_text(color = "black", size = 13)) + -->
<!--   facet_grid(Dataset ~ .)  -->

<!-- ggplot(budbreak_budset_comb, aes(x = traitcGDD, y = traitBudSet, group = Population, color = PC1)) + -->
<!--   geom_point(aes(shape = Region), size=3, alpha = 0.7) +  -->
<!--   scale_color_viridis(option = "A", direction = -1) + -->
<!--   labs(x = "Budbreak in cGDD", y = "Budset in DOY") +  -->
<!--   theme_bw() + theme(axis.text=element_text(size=14),  -->
<!--                      axis.title=element_text(size=14,face="bold"), -->
<!--                      legend.title = element_text(color = "black", size = 14), -->
<!--                      legend.text = element_text(color = "black", size = 13)) + -->
<!--   facet_grid(Dataset ~ .) -->
<!-- ``` -->

# Within trait correlations  
## Budset 2019-Budset 2020 {.tabset .tabset-fade .tabset-pills}  
### Summary  
```{r}
bs_19_bs_20_fam_blup_pop_corr <- readRDS("./genetic_correlation_outputs/bs_19_bs_20_fam_blup_pop_corr")

summary(bs_19_bs_20_fam_blup_pop_corr)
effectiveSize(bs_19_bs_20_fam_blup_pop_corr$VCV)
heidel.diag(bs_19_bs_20_fam_blup_pop_corr$VCV)
```

```{r}
head(bs_19_bs_20_fam_blup_pop_corr$VCV)
# genetic correlation
bs_19_bs_20_pop_gencorr <- bs_19_bs_20_fam_blup_pop_corr$VCV[,"traitBudSet2019:traitBudSet2020.Population"]/sqrt(bs_19_bs_20_fam_blup_pop_corr$VCV[,"traitBudSet2019:traitBudSet2019.Population"] * bs_19_bs_20_fam_blup_pop_corr$VCV[,"traitBudSet2020:traitBudSet2020.Population"])

posterior.mode(bs_19_bs_20_pop_gencorr)
HPDinterval(bs_19_bs_20_pop_gencorr)
```

### Data  
**MCMC**  
```{r}
## setting up dataframe for correlation based on the model blups
bs_19_bs_20_coefs <- data_frame(Trait = attr(colMeans(bs_19_bs_20_fam_blup_pop_corr$Sol), "names"),
                                Value = colMeans(bs_19_bs_20_fam_blup_pop_corr$Sol)) %>%
  separate(Trait, c("Trait","Type","Population"), sep = "\\.", fill = "right") %>%
  filter(Type == "Population") %>%
  filter(Trait %in% c("traitBudSet2019", "traitBudSet2020")) %>%
  select(-Type) %>%
  spread(Trait, Value)


bs_19_bs_20_coefs <- merge(x=bs_19_bs_20_coefs,
                           y=exome_meta[,c("Pop","Region")],
                           all.x=T,
                           by.x="Population",
                           by.y="Pop")

# rename regions
bs_19_bs_20_coefs$Region <- revalue(bs_19_bs_20_coefs$Region, c("C"="Core", "M"="Margin","E"="Edge")) 
# reorder regions
bs_19_bs_20_coefs$Region <- factor(bs_19_bs_20_coefs$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
bs_19_bs_20_coefs <- merge(x=bs_19_bs_20_coefs,
                           y=Population_climateNA[,c("Population","PC1","MAT")],
                           by="Population")
cor.test(bs_19_bs_20_coefs$traitBudSet2020,bs_19_bs_20_coefs$traitBudSet2019) #0.4646913  
```

**Family**  
```{r}
budset_2019 <- budset_19
colnames(budset_2019)[colnames(budset_2019)=="BudSet"] <- "BudSet2019"
budset_2020 <- budset_20
colnames(budset_2020)[colnames(budset_2020)=="BudSet"] <- "BudSet2020"

bs_19_bs_20 <- merge(budset_2019,budset_2020[,c("Family","BudSet2020")])
bs_19_bs_20 <- bs_19_bs_20[!is.na(bs_19_bs_20$BudSet2020),]
bs_19_bs_20 <- bs_19_bs_20[!is.na(bs_19_bs_20$BudSet2019),]

# merge Region data
bs_19_bs_20 <- merge(x=bs_19_bs_20,
                               y=exome_meta[,c("Pop","Region")],
                               by.x="Population",
                               by.y="Pop")

# rename and  reorder regions
bs_19_bs_20$Region <- plyr::revalue(bs_19_bs_20$Region,
                               c("C" = "Core",
                                 "M" = "Margin",
                                 "E" = "Edge"))
bs_19_bs_20$Region <- factor(bs_19_bs_20$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
bs_19_bs_20 <- merge(x=bs_19_bs_20,
                               y=Family_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

bs_19_bs_20 <- distinct(bs_19_bs_20)
```

**Population**   
```{r}
bs_19_bs_20$Population <- as.factor(bs_19_bs_20$Population)

bs_19_bs_20_pop <- bs_19_bs_20 %>%
                            select(Population, BudSet2019, BudSet2020, Region) %>%
                            group_by(Population) %>%
                            dplyr::summarise(BudSet2019 = mean(BudSet2019), BudSet2020 = mean(BudSet2020))

bs_19_bs_20_pop <- merge(x=bs_19_bs_20_pop,
                               y=Population_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

bs_19_bs_20_pop <- merge(x=bs_19_bs_20_pop,
                               y=exome_meta[,c("Pop","Region")],
                               by.x="Population",
                               by.y="Pop")
# rename and  reorder regions
bs_19_bs_20_pop$Region <- plyr::revalue(bs_19_bs_20_pop$Region,
                               c("C" = "Core",
                                 "M" = "Margin",
                                 "E" = "Edge"))
bs_19_bs_20_pop$Region <- factor(bs_19_bs_20_pop$Region,levels = c("Core", "Margin", "Edge"))

bs_19_bs_20_pop <- distinct(bs_19_bs_20_pop)
```

### MCMC plot
```{r}
# plot
ggplot(bs_19_bs_20_coefs, aes(x = traitBudSet2020, y = traitBudSet2019, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Budset in 2020", y = "Budset in 2019") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) #+
  # annotate("text", label = "Correlation between traits: 0.465", x = 1.1, y = -1.7)
```

### Family plot
```{r}
# plot
ggplot(bs_19_bs_20, aes(x = BudSet2019, y = BudSet2020, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Budset in 2019", y = "Budset in 2020") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) #+
  # annotate("text", label = "Correlation between traits: 0.465", x = 1.1, y = -1.7)
```

### Population plot
```{r}
# plot
ggplot(bs_19_bs_20_pop, aes(x = BudSet2019, y = BudSet2020, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Budset in 2019", y = "Budset in 2020") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) 
```

## Growth 2019-Growth 2020 {.tabset .tabset-fade .tabset-pills}  
### Summary  
```{r}
gw_19_gw_20_fam_blup_pop_corr <- readRDS("./genetic_correlation_outputs/gw_19_gw_20_fam_blup_pop_corr")

summary(gw_19_gw_20_fam_blup_pop_corr)
effectiveSize(gw_19_gw_20_fam_blup_pop_corr$VCV)
heidel.diag(gw_19_gw_20_fam_blup_pop_corr$VCV)
```

```{r}
head(gw_19_gw_20_fam_blup_pop_corr$VCV)
# genetic correlation
gw_19_gw_20_pop_gencorr <- gw_19_gw_20_fam_blup_pop_corr$VCV[,"traitGrowth2019:traitGrowth2020.Population"]/sqrt(gw_19_gw_20_fam_blup_pop_corr$VCV[,"traitGrowth2019:traitGrowth2019.Population"] * gw_19_gw_20_fam_blup_pop_corr$VCV[,"traitGrowth2020:traitGrowth2020.Population"])

posterior.mode(gw_19_gw_20_pop_gencorr)
HPDinterval(gw_19_gw_20_pop_gencorr)
```

### Data  
**MCMC**  
```{r}
## setting up dataframe for correlation based on the model blups
gw_19_gw_20_coefs <- data_frame(Trait = attr(colMeans(gw_19_gw_20_fam_blup_pop_corr$Sol), "names"),
                                Value = colMeans(gw_19_gw_20_fam_blup_pop_corr$Sol)) %>%
  separate(Trait, c("Trait","Type","Population"), sep = "\\.", fill = "right") %>%
  filter(Type == "Population") %>%
  filter(Trait %in% c("traitGrowth2019", "traitGrowth2020")) %>%
  select(-Type) %>%
  spread(Trait, Value)


gw_19_gw_20_coefs <- merge(x=gw_19_gw_20_coefs,
                           y=exome_meta[,c("Pop","Region")],
                           all.x=T,
                           by.x="Population",
                           by.y="Pop")

# rename regions
gw_19_gw_20_coefs$Region <- revalue(gw_19_gw_20_coefs$Region, c("C"="Core", "M"="Margin","E"="Edge")) 
# reorder regions
gw_19_gw_20_coefs$Region <- factor(gw_19_gw_20_coefs$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
gw_19_gw_20_coefs <- merge(x=gw_19_gw_20_coefs,
                           y=Population_climateNA[,c("Population","PC1","MAT")],
                           by="Population")
cor.test(gw_19_gw_20_coefs$traitGrowth2019,gw_19_gw_20_coefs$traitGrowth2020) #0.747941
```

**Family**  
```{r}
heightGrowth_2019 <- heightGrowth_19
colnames(heightGrowth_2019)[colnames(heightGrowth_2019)=="Growth"] <- "Growth2019"
heightGrowth_2020 <- heightGrowth_20
colnames(heightGrowth_2020)[colnames(heightGrowth_2020)=="Growth"] <- "Growth2020"

gw_19_gw_20 <- merge(heightGrowth_2019,heightGrowth_2020[,c("Family","Growth2020")])
gw_19_gw_20 <- gw_19_gw_20[!is.na(gw_19_gw_20$Growth2019),]
gw_19_gw_20 <- gw_19_gw_20[!is.na(gw_19_gw_20$Growth2020),]

# merge Region data
gw_19_gw_20 <- merge(x=gw_19_gw_20,
                               y=exome_meta[,c("Pop","Region")],
                               by.x="Population",
                               by.y="Pop")

# rename and  reorder regions
gw_19_gw_20$Region <- plyr::revalue(gw_19_gw_20$Region,
                               c("C" = "Core",
                                 "M" = "Margin",
                                 "E" = "Edge"))
gw_19_gw_20$Region <- factor(gw_19_gw_20$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
gw_19_gw_20 <- merge(x=gw_19_gw_20,
                               y=Family_climateNA[,c("Population","PC1","MAT")],
                               by="Population")
gw_19_gw_20 <- distinct(gw_19_gw_20)
```

**Population**   
```{r}
gw_19_gw_20$Population <- as.factor(gw_19_gw_20$Population)

gw_19_gw_20_pop <- gw_19_gw_20 %>%
                            select(Population, Growth2019, Growth2020, Region) %>%
                            group_by(Population) %>%
                            dplyr::summarise(Growth2019 = mean(Growth2019), Growth2020 = mean(Growth2020))

gw_19_gw_20_pop <- merge(x=gw_19_gw_20_pop,
                               y=Population_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

gw_19_gw_20_pop <- merge(x=gw_19_gw_20_pop,
                               y=exome_meta[,c("Pop","Region")],
                               by.x="Population",
                               by.y="Pop")
# rename and  reorder regions
gw_19_gw_20_pop$Region <- plyr::revalue(gw_19_gw_20_pop$Region,
                               c("C" = "Core",
                                 "M" = "Margin",
                                 "E" = "Edge"))
gw_19_gw_20_pop$Region <- factor(gw_19_gw_20_pop$Region,levels = c("Core", "Margin", "Edge"))

gw_19_gw_20_pop <- distinct(gw_19_gw_20_pop)
```

### MCMC plot  
```{r}
# plot
ggplot(gw_19_gw_20_coefs, aes(x = traitGrowth2020, y = traitGrowth2019, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Height Growth in 2020", y = "Height Growth in 2019") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) #+
  # annotate("text", label = "Correlation between traits: 0.748", x = 3.3, y = -1.2)
```

### Family plot  
```{r}
# plot
ggplot(gw_19_gw_20, aes(x = Growth2019, y = Growth2020, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Height Growth in 2019", y = "Height Growth in 2020") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) #+
  # annotate("text", label = "Correlation between traits: 0.748", x = 3.3, y = -1.2)
```

### Population plot  
```{r}
# plot
ggplot(gw_19_gw_20_pop, aes(x = Growth2019, y = Growth2020, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  labs(x = "Height Growth in 2019", y = "Height Growth in 2020") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) 
```

