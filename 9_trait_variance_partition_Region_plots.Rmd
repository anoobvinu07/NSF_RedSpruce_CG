---
title: "Trait variance partition"
author: "Anoob Prakash"
date: "02/02/2021"
output:
  rmarkdown::html_document:
    theme: cosmo  
    number_sections: false
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Methods  
**lmer model equivalent**  
- Garden is set as the fixed effect.  
- mBed (5 beds x 3 sites) is set as random effect.    
- Random effect of family; with slopes to vary with family and intercept to vary with garden site.   

`lmer(Trait ~ 1 + (Garden|Family) + (1|Garden) + (1|mBed) , data=budset_19[budset_19$Region == "Core",])`  

**MCMC model** 
- The scaled family blups of the traits are used as input MCMC run.  
- Random effect of mBed accounted for in this model.  
- Intercept to vary with Garden and slope to vary with family to account for GxE.  

```
MCMCglmm(Trait ~ Garden, 
                          random= ~ idh(1+Garden):Family + Garden + mBed,
                          family="gaussian",
                          data=budset_19[budset_19$Region=="Core",],
                          prior=Prior, 
                          pr=TRUE, # save random effects 
                          # burnin=100 , nitt=100000 , thin=100) # testing
                          burnin=10000 , nitt=10000000 , thin=1000)
```

**Prior**  
- testing prior [https://stat.ethz.ch/pipermail/r-sig-mixed-models/2013q4/021287.html]   
- current prior based on page 68 of the course notes for MCMCglmm  
  - https://cran.r-project.org/web/packages/MCMCglmm/vignettes/CourseNotes.pdf  

```
Prior <- list(R=list(V = diag(1), nu = 0.002),           # R - prior on residual variance  
              G = list(                                  # G - list of priors for random effect variance  
                G1 = list(V = diag(3) * 0.02, nu = 4),   
                G2 = list(V = 1, nu = 0.002)))
```  

- notes from: https://stat.ethz.ch/pipermail/r-sig-mixed-models/2017q1/025532.html  
- multiresponse mcmc models, page 92: https://cran.r-project.org/web/packages/MCMCglmm/vignettes/CourseNotes.pdf  

## packages  
```{r message=FALSE, warning=FALSE}
suppressPackageStartupMessages({
require(MCMCglmm)
require(lmerTest)
require(dplyr)
require(tidyr)
require(plyr)
require(viridis)
})
# require(grid)
# require(gridExtra)

# setwd("Z:/Anoob/MCMCglmm")
```

# Phenology   
## Budset 2019 {.tabset .tabset-fade .tabset-pills}  

### Core  
```{r cache=TRUE}
bs_19_mod_Core <-  readRDS("./region_varPart_outputs/bs_19_mod_Core")
```


```{r}
summary(bs_19_mod_Core)
posterior.mode(bs_19_mod_Core$VCV)
HPDinterval(bs_19_mod_Core$VCV)

# diagnostics 
effectiveSize(bs_19_mod_Core$VCV)
heidel.diag(bs_19_mod_Core$VCV)
```


```{r}
# table
bs_19_Core <- data.frame("Variance" = c("G",         "GxE",    "E",   "Bed", "Total"),
                         "Value"    = c(86.96588,   0.09153,   1191,  25.27, 2043.127),
                         "Percent"  = c(0.04256509, 4.479898e-05, 0.58293,0.0123683, 1))

knitr::kable(bs_19_Core)

# reorder regions
bs_19_Core$Variance <- factor(bs_19_Core$Variance,levels = c("E", "GxE", "G"))

ggplot(data=bs_19_Core[1:3,c(1,3)], mapping=aes(x=Variance, y=Percent)) + 
  stat_summary(geom="bar", fill = "grey73") + coord_flip() + theme_bw() +  
  theme(axis.text=element_text(size=30, face = "bold"), 
        axis.title=element_blank(),
        legend.position = "none",
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        plot.margin = unit(c(1,1,1,1), "cm")) 

```

### Margin   
```{r cache=TRUE}
bs_19_mod_Margin <-  readRDS("./region_varPart_outputs/bs_19_mod_Margin")
```


```{r}
summary(bs_19_mod_Margin)
posterior.mode(bs_19_mod_Margin$VCV)
HPDinterval(bs_19_mod_Margin$VCV)

# diagnostics 
effectiveSize(bs_19_mod_Margin$VCV)
heidel.diag(bs_19_mod_Margin$VCV)
```

```{r}
# table
bs_19_Margin <- data.frame("Variance"  = c(  "G"  ,    "GxE" ,   "E"  ,   "Bed"  , "Total"),
                            "Value"    = c(56.49151,  0.13459,  2972,    22.77,     3800.596),
                            "Percent"  = c(0.01486386, 3.541287e-05, 0.7819826, 0.005991166, 1))

knitr::kable(bs_19_Margin)

# reorder regions
bs_19_Margin$Variance <- factor(bs_19_Margin$Variance,levels = c("E", "GxE", "G"))

ggplot(data=bs_19_Margin[1:3,c(1,3)], mapping=aes(x=Variance, y=Percent)) + 
  stat_summary(geom="bar", fill = "grey73") + coord_flip() + theme_bw() +  
  theme(axis.text=element_text(size=30, face = "bold"), 
        axis.title=element_blank(),
        legend.position = "none",
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        plot.margin = unit(c(1,1,1,1), "cm"))

```

### Edge  
```{r cache=TRUE}
bs_19_mod_Edge <-  readRDS("./region_varPart_outputs/bs_19_mod_Edge")
```


```{r}
summary(bs_19_mod_Edge)
posterior.mode(bs_19_mod_Edge$VCV)
HPDinterval(bs_19_mod_Edge$VCV)

# diagnostics 
effectiveSize(bs_19_mod_Edge$VCV)
heidel.diag(bs_19_mod_Edge$VCV)
```

```{r}
# table
bs_19_Edge <- data.frame("Variance"  = c(  "G"  ,    "GxE" ,   "E"  ,   "Bed"  , "Total"),
                            "Value"    = c(0.94822,  2.90125,  1085,    21.4,    1639.549 ),
                            "Percent"  = c(0.000578342, 0.001769542, 0.6617674, 0.01305237, 1))

knitr::kable(bs_19_Edge)

# reorder regions
bs_19_Edge$Variance <- factor(bs_19_Edge$Variance,levels = c("E", "GxE", "G"))

ggplot(data=bs_19_Edge[1:3,c(1,3)], mapping=aes(x=Variance, y=Percent)) + 
  stat_summary(geom="bar", fill = "grey73") + coord_flip() + theme_bw() +  
  theme(axis.text=element_text(size=30, face = "bold"), 
        axis.title=element_blank(),
        legend.position = "none",
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        plot.margin = unit(c(1,1,1,1), "cm")) 

```


## Budset 2020 {.tabset .tabset-fade .tabset-pills}  

### Core  
```{r cache=TRUE}
bs_20_mod_Core <-  readRDS("./region_varPart_outputs/bs_20_mod_Core")
```


```{r}
summary(bs_20_mod_Core)
```
- Very high GxE at the Vermont site   

```{r}
posterior.mode(bs_20_mod_Core$VCV)
HPDinterval(bs_20_mod_Core$VCV)

# diagnostics 
effectiveSize(bs_20_mod_Core$VCV)
heidel.diag(bs_20_mod_Core$VCV)
```

```{r}
# table
bs_20_Core <- data.frame("Variance" = c("G",         "GxE",    "E",   "Bed", "Total"),
                         "Value"    = c(0.05841,   53.68542,   2653,  12.35, 2719.094),
                         "Percent"  = c(2.148142e-05, 0.01974386, 0.9756926,0.004541954, 1))

knitr::kable(bs_20_Core)

# reorder regions
bs_20_Core$Variance <- factor(bs_20_Core$Variance,levels = c("E", "GxE", "G"))

ggplot(data=bs_20_Core[1:3,c(1,3)], mapping=aes(x=Variance, y=Percent)) + 
  stat_summary(geom="bar", fill = "grey73") + coord_flip() + theme_bw() +  
  theme(axis.text=element_text(size=30, face = "bold"), 
        axis.title=element_blank(),
        legend.position = "none",
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        plot.margin = unit(c(1,1,1,1), "cm")) 

```

### Margin   
```{r cache=TRUE}
bs_20_mod_Margin <-  readRDS("./region_varPart_outputs/bs_20_mod_Margin")
```


```{r}
summary(bs_20_mod_Margin)
posterior.mode(bs_20_mod_Margin$VCV)
HPDinterval(bs_20_mod_Margin$VCV)

# diagnostics 
effectiveSize(bs_20_mod_Margin$VCV)
heidel.diag(bs_20_mod_Margin$VCV)
```

```{r}
# table
bs_20_Margin <- data.frame("Variance" = c("G",         "GxE",    "E",   "Bed", "Total"),
                         "Value"    = c(55.57686,  0.07966 ,   3236, 18.66 , 3310.317),
                         "Percent"  = c(0.01678898, 2.406416e-05, 0.9775499,0.005636922, 1))

knitr::kable(bs_20_Margin)

# reorder regions
bs_20_Margin$Variance <- factor(bs_20_Margin$Variance,levels = c("E", "GxE", "G"))

ggplot(data=bs_20_Margin[1:3,c(1,3)], mapping=aes(x=Variance, y=Percent)) + 
  stat_summary(geom="bar", fill = "grey73") + coord_flip() + theme_bw() +  
  theme(axis.text=element_text(size=30, face = "bold"), 
        axis.title=element_blank(),
        legend.position = "none",
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        plot.margin = unit(c(1,1,1,1), "cm")) 

```

### Edge  
```{r cache=TRUE}
bs_20_mod_Edge <- readRDS("./region_varPart_outputs/bs_20_mod_Edge")
```


```{r}
summary(bs_20_mod_Edge)
posterior.mode(bs_20_mod_Edge$VCV)
HPDinterval(bs_20_mod_Edge$VCV)

# diagnostics 
effectiveSize(bs_20_mod_Edge$VCV)
heidel.diag(bs_20_mod_Edge$VCV)
```

```{r}
# table
bs_20_Edge <- data.frame("Variance" = c("G",         "GxE",    "E",   "Bed", "Total"),
                         "Value"    = c(0.19707,   0.48429,   2275    , 11.37 , 2287.051 ),
                         "Percent"  = c(8.616773e-05, 0.000211753, 0.9947308, 0.004971468, 1))

knitr::kable(bs_20_Edge)

# reorder regions
bs_20_Edge$Variance <- factor(bs_20_Edge$Variance,levels = c("E", "GxE", "G"))

ggplot(data=bs_20_Edge[1:3,c(1,3)], mapping=aes(x=Variance, y=Percent)) + 
  stat_summary(geom="bar", fill = "grey73") + coord_flip() + theme_bw() +  
  theme(axis.text=element_text(size=30, face = "bold"), 
        axis.title=element_blank(),
        legend.position = "none",
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        plot.margin = unit(c(1,1,1,1), "cm")) 

```

## Budbreak 2020  {.tabset .tabset-fade .tabset-pills}  

### Core  
```{r cache=TRUE}
bb_20_mod_Core <-  readRDS("./region_varPart_outputs/bb_20_mod_Core")
```


```{r}
summary(bb_20_mod_Core)
posterior.mode(bb_20_mod_Core$VCV)
HPDinterval(bb_20_mod_Core$VCV)

# diagnostics 
effectiveSize(bb_20_mod_Core$VCV)
heidel.diag(bb_20_mod_Core$VCV)
```

```{r}
# table
bb_20_Core <- data.frame("Variance" = c("G",         "GxE",    "E",   "Bed", "Total"),
                         "Value"    = c(85.30827 ,  510.3853 ,  42844  , 17.48 , 43457.17 ),
                         "Percent"  = c(0.001963042, 0.01174456, 0.9858902,0.0004022351, 1))

knitr::kable(bb_20_Core)

# reorder regions
bb_20_Core$Variance <- factor(bb_20_Core$Variance,levels = c("E", "GxE", "G"))

ggplot(data=bb_20_Core[1:3,c(1,3)], mapping=aes(x=Variance, y=Percent)) + 
  stat_summary(geom="bar", fill = "grey73") + coord_flip() + theme_bw() +  
  theme(axis.text=element_text(size=30, face = "bold"), 
        axis.title=element_blank(),
        legend.position = "none",
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        plot.margin = unit(c(1,1,1,1), "cm")) 

```

### Margin   
```{r cache=TRUE}
bb_20_mod_Margin <-  readRDS("./region_varPart_outputs/bb_20_mod_Margin")
```


```{r}
summary(bb_20_mod_Margin)
posterior.mode(bb_20_mod_Margin$VCV)
HPDinterval(bb_20_mod_Margin$VCV)

# diagnostics 
effectiveSize(bb_20_mod_Margin$VCV)
heidel.diag(bb_20_mod_Margin$VCV)
```

```{r}
# table
bb_20_Margin <- data.frame("Variance" = c("G",         "GxE",    "E",   "Bed", "Total"),
                         "Value"    = c( 300.94559,   5.93718,   114379 , 5.03 ,  114690.9),
                         "Percent"  = c(0.002623971, 5.176679e-05, 0.9972805,4.385701e-05, 1))

knitr::kable(bb_20_Margin)

# reorder regions
bb_20_Margin$Variance <- factor(bb_20_Margin$Variance,levels = c("E", "GxE", "G"))

ggplot(data=bb_20_Margin[1:3,c(1,3)], mapping=aes(x=Variance, y=Percent)) + 
  stat_summary(geom="bar", fill = "grey73") + coord_flip() + theme_bw() +  
  theme(axis.text=element_text(size=30, face = "bold"), 
        axis.title=element_blank(),
        legend.position = "none",
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        plot.margin = unit(c(1,1,1,1), "cm")) 

```

### Edge  
```{r cache=TRUE}
bb_20_mod_Edge <-  readRDS("./region_varPart_outputs/bb_20_mod_Edge")
```


```{r}
summary(bb_20_mod_Edge)
posterior.mode(bb_20_mod_Edge$VCV)
HPDinterval(bb_20_mod_Edge$VCV)

# diagnostics 
effectiveSize(bb_20_mod_Edge$VCV)
heidel.diag(bb_20_mod_Edge$VCV)
```

```{r}
# table
bb_20_Edge <- data.frame("Variance" = c("G",         "GxE",    "E",   "Bed", "Total"),
                         "Value"    = c( 41.18225,  14.44814 ,  107567  , 1.022 , 107623.7 ),
                         "Percent"  = c(0.0003826504, 0.0001342468, 0.9994732, 9.49605e-06, 1))

knitr::kable(bb_20_Edge)

# reorder regions
bb_20_Edge$Variance <- factor(bb_20_Edge$Variance,levels = c("E", "GxE", "G"))

ggplot(data=bb_20_Edge[1:3,c(1,3)], mapping=aes(x=Variance, y=Percent)) + 
  stat_summary(geom="bar", fill = "grey73") + coord_flip() + theme_bw() +  
  theme(axis.text=element_text(size=30, face = "bold"), 
        axis.title=element_blank(),
        legend.position = "none",
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        plot.margin = unit(c(1,1,1,1), "cm")) 

```

# Growth  

## Growth 2019 {.tabset .tabset-fade .tabset-pills}  

### Core  
```{r cache=TRUE}
gw_19_mod_Core <-  readRDS("./region_varPart_outputs/gw_19_mod_Core")
```


```{r}
summary(gw_19_mod_Core)
posterior.mode(gw_19_mod_Core$VCV)
HPDinterval(gw_19_mod_Core$VCV)

# diagnostics 
effectiveSize(gw_19_mod_Core$VCV)
heidel.diag(gw_19_mod_Core$VCV)
```

### Margin   
```{r cache=TRUE}
gw_19_mod_Margin <- readRDS("./region_varPart_outputs/gw_19_mod_Margin")
```


```{r}
summary(gw_19_mod_Margin)
posterior.mode(gw_19_mod_Margin$VCV)
HPDinterval(gw_19_mod_Margin$VCV)

# diagnostics 
effectiveSize(gw_19_mod_Margin$VCV)
heidel.diag(gw_19_mod_Margin$VCV)
```

### Edge  
```{r cache=TRUE}
gw_19_mod_Edge <-  readRDS("./region_varPart_outputs/gw_19_mod_Edge")
```


```{r}
summary(gw_19_mod_Edge)
posterior.mode(gw_19_mod_Edge$VCV)
HPDinterval(gw_19_mod_Edge$VCV)

# diagnostics 
effectiveSize(gw_19_mod_Edge$VCV)
heidel.diag(gw_19_mod_Edge$VCV)
```


## Growth 2020 {.tabset .tabset-fade .tabset-pills}  

### Core  
```{r cache=TRUE}
gw_20_mod_Core <-  readRDS("./region_varPart_outputs/gw_20_mod_Core")
```


```{r}
summary(gw_20_mod_Core)
posterior.mode(gw_20_mod_Core$VCV)
HPDinterval(gw_20_mod_Core$VCV)

# diagnostics 
effectiveSize(gw_20_mod_Core$VCV)
heidel.diag(gw_20_mod_Core$VCV)
```

### Margin   
```{r cache=TRUE}
gw_20_mod_Margin <-  readRDS("./region_varPart_outputs/gw_20_mod_Margin")
```


```{r}
summary(gw_20_mod_Margin)
posterior.mode(gw_20_mod_Margin$VCV)
HPDinterval(gw_20_mod_Margin$VCV)

# diagnostics 
effectiveSize(gw_20_mod_Margin$VCV)
heidel.diag(gw_20_mod_Margin$VCV)
```

### Edge  
```{r cache=TRUE}
gw_20_mod_Edge <-  readRDS("./region_varPart_outputs/gw_20_mod_Edge")
```


```{r}
summary(gw_20_mod_Edge)
posterior.mode(gw_20_mod_Edge$VCV)
HPDinterval(gw_20_mod_Edge$VCV)

# diagnostics 
effectiveSize(gw_20_mod_Edge$VCV)
heidel.diag(gw_20_mod_Edge$VCV)
```