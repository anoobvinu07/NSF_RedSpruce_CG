---
title: "Trait plasticity based on climate transfer distance"
author: "Anoob Prakash"
date: "02/03/2021"
output:
  rmarkdown::html_document:
    theme: cosmo  
    number_sections: false
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Methods  
**family BLUP model**  
- Mixed effect model run to get the family level blups for use in the MCMC run.  
- Garden is set as the fixed effect.  
- Family and mBed (5 beds x 3 sites) set as random effect.  
- Height growth for a season is used as the fitness proxy to compare the adaptive nature of trait plasticity.  
  - This helps in explaining whether the change in plasticity for a trait (positive/negative) is adaptive (top right of the plot) or maladaptive (bottom left of the plot).  
  
```
# Creating mBed
fitness <- fitness %>% unite(mBed, Garden, Bed, sep = "_", remove = FALSE)

# lmer model for family blup 
fitness_mod <- lmer(Growth ~ Garden + (1|mBed) + (1|Family), fitness)

# extract the blups for the family from the model  
fitness_blup <- ranef(fitness_mod)
fitness_blup <- fitness_blup$Family
fitness_blup <- cbind(Family=rownames(fitness_blup),fitness_blup)
rownames(fitness_blup) <- NULL
names(fitness_blup)[2] <- "fitness"
```
**Trait plasticity**  
- Trait values selected are based on climate transfer distance between the source and site.  
  - The garden sites closest to the source of an individual based on their MAT is considered as `home`.  
  - The garden sites farthest from the source of an individual based on their MAT is considered as `away`.  

- The difference between the trait values at home vs away is used to estimate the plasticity present in a trait.  

 $$Plasticity = (trait@home - trait@away ) / (trait@home)$$  
 
![Calcualting plasticity based on the CTD between source and site](./plasticity_illustrated.png)
 
 
**Adaptive plasticity model**  
- Height was selected as proxy for fitness  
- Absolute plasticity of the trait correlated with fitness to check whether the plasticity is adaptive, maladaptive or neutral  

```
Absolute_plasticity <- Height_Growth ~ Abs_P + Region + Abs_P * Region
```
![Estimating the adaptive or maladaptive nature of trait plasticity](./adaptive_plasticity.png)


## notes  
gw - growth  
bb - budbreak  
bs - budset  
B - lmer family blups (means)  
P - plasticity value for the trait 

# packages
```{r}
suppressPackageStartupMessages({
require(ggplot2)
require(lmerTest)
require(dplyr)
require(tidyr)
require(MCMCglmm)
require(plyr)
require(viridis)
require(sjPlot)
require(sjmisc)
require(cowplot)
})
```


```{r}
# setwd("Z:/Anoob/MCMCglmm")

# exome data
exome_meta <- read.table("./Exome/RS_Exome_metadata.txt", sep="\t", header = T)

# climateNA
Population_climateNA <- read.csv("./ClimateNA/Family/PCA_sprucePops.txt", header=T, sep="\t")
colnames(Population_climateNA)[colnames(Population_climateNA)=="PC1_sel"] <- "PC1"

Family_climateNA <- read.csv("./ClimateNA/Family/PCA_spruceFams.txt", header=T, sep="\t")
colnames(Family_climateNA)[colnames(Family_climateNA)=="PC1_sel"] <- "PC1"
```

# Data  
```{r}
budset_2019 <- read.csv("./trait_data/BudSet_2019.csv")
budset_2020 <- read.csv("./trait_data/BudSet_2020.csv")
budbreak_2020 <- read.csv("./trait_data/BudBreak_2020_cGDD.csv")
heightGrowth_2019 <- read.csv("./trait_data/Growth_2019.csv")
heightGrowth_2020 <- read.csv("./trait_data/Growth_2020.csv")
Plasticity <- read.csv("./trait_data/Plasticity_TD.csv")

# Region palette
reg_palette <- c("goldenrod2","green2","steelblue")

```


## Height growth of 2019 - Means vs Plasticity  {.tabset .tabset-fade .tabset-pills}  

### Family data  
```{r}
# blups for height growth
heightGrowth_2019_2 <- heightGrowth_2019
heightGrowth_2019_2 <- heightGrowth_2019_2%>% unite(mBed, Garden, Bed, sep = "_", remove = FALSE)

HeightGrowth_2019_mod <- lmer(Growth ~ Garden + (1|mBed) + (1|Family), heightGrowth_2019_2)

HeightGrowth_2019_blup <- ranef(HeightGrowth_2019_mod)
HeightGrowth_2019_blup <- HeightGrowth_2019_blup$Family
HeightGrowth_2019_blup <- cbind(Family=rownames(HeightGrowth_2019_blup),HeightGrowth_2019_blup)
rownames(HeightGrowth_2019_blup) <- NULL
names(HeightGrowth_2019_blup)[2] <- "Height_Growth"

# plasticity based on height growth 
HeightGrowth_2019_blup <- merge(x=HeightGrowth_2019_blup,
                                y=Plasticity[,c("Family","growth2019_Plasticity")],
                                by="Family")
# rename plasticity column
colnames(HeightGrowth_2019_blup)[colnames(HeightGrowth_2019_blup)=="growth2019_Plasticity"] <- "Plasticity"

# remove NAs
HeightGrowth_2019_blup <- HeightGrowth_2019_blup[!is.na(HeightGrowth_2019_blup$Plasticity),]

# Population column creation
HeightGrowth_2019_blup$Population <- gsub("\\_.*", "", HeightGrowth_2019_blup$Family)

# merge climateNA data
HeightGrowth_2019_blup <- merge(x=HeightGrowth_2019_blup,
                               y=Family_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

# merge Region data
HeightGrowth_2019_blup <- merge(x=HeightGrowth_2019_blup,
                               y=heightGrowth_2019[,c("Population","Region")],
                               by="Population")

# reorder regions
HeightGrowth_2019_blup$Region <- factor(HeightGrowth_2019_blup$Region,levels = c("Core", "Margin", "Edge"))

HeightGrowth_2019_blup <- distinct(HeightGrowth_2019_blup)

HeightGrowth_2019_blup$Abs_P <- abs(HeightGrowth_2019_blup$Plasticity)
```

### Population data  
```{r}
HeightGrowth_2019_blup$Population <- as.factor(HeightGrowth_2019_blup$Population)

HeightGrowth_2019_pop <- HeightGrowth_2019_blup %>%
                            select(Population, Height_Growth, Plasticity, Region) %>%
                            group_by(Population) %>%
                            dplyr::summarise(Height_Growth = mean(Height_Growth), Plasticity = mean(Plasticity))

HeightGrowth_2019_pop <- merge(x=HeightGrowth_2019_pop,
                               y=Population_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

HeightGrowth_2019_pop <- merge(x=HeightGrowth_2019_pop,
                               y=heightGrowth_2019[,c("Population","Region")],
                               by="Population")
# reorder regions
HeightGrowth_2019_pop$Region <- factor(HeightGrowth_2019_pop$Region,levels = c("Core", "Margin", "Edge"))

HeightGrowth_2019_pop <- distinct(HeightGrowth_2019_pop)

HeightGrowth_2019_pop$Abs_P <- abs(HeightGrowth_2019_pop$Plasticity)
```


### Family plot  

```{r}
HeightGrowth_2019_fam_abs_mod <- lm(Height_Growth ~ Abs_P + Region + Abs_P*Region,
                                    data=HeightGrowth_2019_blup)
summary(HeightGrowth_2019_fam_abs_mod)

```
- Absolute plasticity is not significant.  
- Absolute plasticity's interaction with Core and Edge region are significant***.  

```{r echo=F}


# region inset
HeightGrowth_2019_blup_inset2 <- sjPlot::plot_model(HeightGrowth_2019_fam_abs_mod, type = "int",  colors=reg_palette) +
                                labs(x = "Absolute plasticity", y = "Height Growth (BLUP)") + 
                                theme_bw() + theme(axis.text=element_text(size=10), 
                                                 axis.title=element_text(size=12),
                                                 legend.position = "top",
                                                 plot.background = element_blank(),
                                                 panel.grid.major = element_blank(),
                                                 panel.grid.minor = element_blank(),
                                                 panel.background = element_blank(),
                                                 plot.title = element_blank()) 



HeightGrowth_2019_blup_inset2
```

### Population plot  

```{r}
HeightGrowth_2019_pop_abs_mod <- lm(Height_Growth ~ Abs_P + Region + Abs_P*Region,
                                    data=HeightGrowth_2019_pop)
summary(HeightGrowth_2019_pop_abs_mod)
```
- Absolute plasticity is not significant.  
- Absolute plasticity's interaction with Core, Margin and Edge region are significant*.   

```{r echo=F}
# region inset
HeightGrowth_2019_pop_inset2 <- sjPlot::plot_model(HeightGrowth_2019_pop_abs_mod, type = "int",  colors=reg_palette) +
                                labs(x = "Absolute plasticity", y = "Fitness") + 
                                theme_bw() + theme(axis.text=element_text(size=10), 
                                                 axis.title=element_text(size=12),
                                                 legend.position = "top",
                                                 plot.background = element_blank(),
                                                 panel.grid.major = element_blank(),
                                                 panel.grid.minor = element_blank(),
                                                 panel.background = element_blank(),
                                                 plot.title = element_blank()) 


HeightGrowth_2019_pop_inset2
```

## Height growth of 2020 - Means vs Plasticity    {.tabset .tabset-fade .tabset-pills}  

### Family data  
```{r}
# blups for height growth
heightGrowth_2020_2 <- heightGrowth_2020
heightGrowth_2020_2 <- heightGrowth_2020_2%>% unite(mBed, Garden, Bed, sep = "_", remove = FALSE)

HeightGrowth_2020_mod <- lmer(Growth ~ Garden + (1|mBed) + (1|Family), heightGrowth_2020_2)

HeightGrowth_2020_blup <- ranef(HeightGrowth_2020_mod)
HeightGrowth_2020_blup <- HeightGrowth_2020_blup$Family
HeightGrowth_2020_blup <- cbind(Family=rownames(HeightGrowth_2020_blup),HeightGrowth_2020_blup)
rownames(HeightGrowth_2020_blup) <- NULL
names(HeightGrowth_2020_blup)[2] <- "Height_Growth"

# plasticity based on height growth 
HeightGrowth_2020_blup <- merge(x=HeightGrowth_2020_blup,
                                y=Plasticity[,c("Family","growth2020_Plasticity")],
                                by="Family")
# rename plasticity column
colnames(HeightGrowth_2020_blup)[colnames(HeightGrowth_2020_blup)=="growth2020_Plasticity"] <- "Plasticity"

# remove NAs
HeightGrowth_2020_blup <- HeightGrowth_2020_blup[!is.na(HeightGrowth_2020_blup$Plasticity),]

# Population column creation
HeightGrowth_2020_blup$Population <- gsub("\\_.*", "", HeightGrowth_2020_blup$Family)

# merge climateNA data
HeightGrowth_2020_blup <- merge(x=HeightGrowth_2020_blup,
                               y=Family_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

# merge Region data
HeightGrowth_2020_blup <- merge(x=HeightGrowth_2020_blup,
                               y=heightGrowth_2020[,c("Population","Region")],
                               by="Population")
# reorder regions
HeightGrowth_2020_blup$Region <- factor(HeightGrowth_2020_blup$Region,levels = c("Core", "Margin", "Edge"))

HeightGrowth_2020_blup <- distinct(HeightGrowth_2020_blup)

HeightGrowth_2020_blup$Abs_P <- abs(HeightGrowth_2020_blup$Plasticity)
```

### Population data  
```{r}
HeightGrowth_2020_blup$Population <- as.factor(HeightGrowth_2020_blup$Population)

HeightGrowth_2020_pop <- HeightGrowth_2020_blup %>%
                            select(Population, Height_Growth, Plasticity, Region) %>%
                            group_by(Population) %>%
                            dplyr::summarise(Height_Growth = mean(Height_Growth), Plasticity = mean(Plasticity))

HeightGrowth_2020_pop <- merge(x=HeightGrowth_2020_pop,
                               y=Population_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

HeightGrowth_2020_pop <- merge(x=HeightGrowth_2020_pop,
                               y=heightGrowth_2019[,c("Population","Region")],
                               by="Population")
# reorder regions
HeightGrowth_2020_pop$Region <- factor(HeightGrowth_2020_pop$Region,levels = c("Core", "Margin", "Edge"))

HeightGrowth_2020_pop <- distinct(HeightGrowth_2020_pop)

HeightGrowth_2020_pop$Abs_P <- abs(HeightGrowth_2020_pop$Plasticity)
```

### Family plot  

```{r}
HeightGrowth_2020_fam_abs_mod <- lm(Height_Growth ~ Abs_P + Region + Abs_P*Region,
                                    data=HeightGrowth_2020_blup)
summary(HeightGrowth_2020_fam_abs_mod)
```

- Absolute plasticity is significant***.  
- Absolute plasticity's interaction with Core and Margin region is significant***.


```{r echo=F}
# region inset
HeightGrowth_2020_blup_inset2 <- sjPlot::plot_model(HeightGrowth_2020_fam_abs_mod, type = "int",  colors=reg_palette) +
                                labs(x = "Absolute plasticity", y = "Fitness") + 
                                theme_bw() + theme(axis.text=element_text(size=10), 
                                                 axis.title=element_text(size=12),
                                                 legend.position = "top",
                                                 plot.background = element_blank(),
                                                 panel.grid.major = element_blank(),
                                                 panel.grid.minor = element_blank(),
                                                 panel.background = element_blank(),
                                                 plot.title = element_blank()) 


```

### Population plot   

```{r}
HeightGrowth_2020_pop_abs_mod <- lm(Height_Growth ~ Abs_P + Region + Abs_P*Region,
                                    data=HeightGrowth_2020_pop)
summary(HeightGrowth_2020_pop_abs_mod)
```

- Absolute plasticity is significant*.  
- Absolute plasticity's interaction with Margin region is significant***.

```{r echo=F}

# region inset
HeightGrowth_2020_pop_inset2 <- sjPlot::plot_model(HeightGrowth_2020_pop_abs_mod, type = "int",  colors=reg_palette) +
                                labs(x = "Absolute plasticity", y = "Fitness") + 
                                theme_bw() + theme(axis.text=element_text(size=10), 
                                                 axis.title=element_text(size=12),
                                                 legend.position = "top",
                                                 plot.background = element_blank(),
                                                 panel.grid.major = element_blank(),
                                                 panel.grid.minor = element_blank(),
                                                 panel.background = element_blank(),
                                                 plot.title = element_blank()) 


HeightGrowth_2020_pop_inset2

```


## Height growth of 2020 means vs budbreak 2020 Plasticity    {.tabset .tabset-fade .tabset-pills}

### Family data  
```{r}
# blups for height growth
heightGrowth_2020_2 <- heightGrowth_2020
heightGrowth_2020_2 <- heightGrowth_2020_2 %>% unite(mBed, Garden, Bed, sep = "_", remove = FALSE)

HeightGrowth_2020_mod <- lmer(Growth ~ Garden + (1|mBed) + (1|Family), heightGrowth_2020_2)

HeightGrowth_2020_blup <- ranef(HeightGrowth_2020_mod)
HeightGrowth_2020_blup <- HeightGrowth_2020_blup$Family
HeightGrowth_2020_blup <- cbind(Family=rownames(HeightGrowth_2020_blup),HeightGrowth_2020_blup)
rownames(HeightGrowth_2020_blup) <- NULL
names(HeightGrowth_2020_blup)[2] <- "Height_Growth"

# plasticity based on budbreak 2020 
gw_20_B_bb_20_P <- merge(x=HeightGrowth_2020_blup,
                         y=Plasticity[,c("Family","BudBreak2020_Plasticity")],
                         by="Family")
# rename plasticity column if needed
colnames(gw_20_B_bb_20_P)[colnames(gw_20_B_bb_20_P)=="BudBreak2020_Plasticity"] <- "BudBreak2020_Plasticity"

# remove NAs
gw_20_B_bb_20_P <- gw_20_B_bb_20_P[!is.na(gw_20_B_bb_20_P$BudBreak2020_Plasticity),]

# Population column creation
gw_20_B_bb_20_P$Population <- gsub("\\_.*", "", gw_20_B_bb_20_P$Family)

# merge climateNA data
gw_20_B_bb_20_P <- merge(x=gw_20_B_bb_20_P,
                               y=Family_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

# merge Region data
gw_20_B_bb_20_P <- merge(x=gw_20_B_bb_20_P,
                               y=heightGrowth_2020[,c("Population","Region")],
                               by="Population")
# reorder regions
gw_20_B_bb_20_P$Region <- factor(gw_20_B_bb_20_P$Region,levels = c("Core", "Margin", "Edge"))


gw_20_B_bb_20_P <- distinct(gw_20_B_bb_20_P)

gw_20_B_bb_20_P$Abs_P <- abs(gw_20_B_bb_20_P$BudBreak2020_Plasticity)
```

### Population data  
```{r}
gw_20_B_bb_20_P$Population <- as.factor(gw_20_B_bb_20_P$Population)

gw_20_B_bb_20_P_pop <- gw_20_B_bb_20_P %>%
                            select(Population, Height_Growth, BudBreak2020_Plasticity, Region) %>%
                            group_by(Population) %>%
                            dplyr::summarise(Height_Growth = mean(Height_Growth), BudBreak2020_Plasticity = mean(BudBreak2020_Plasticity))

gw_20_B_bb_20_P_pop <- merge(x=gw_20_B_bb_20_P_pop,
                               y=Population_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

gw_20_B_bb_20_P_pop <- merge(x=gw_20_B_bb_20_P_pop,
                               y=heightGrowth_2019[,c("Population","Region")],
                               by="Population")
# reorder regions
gw_20_B_bb_20_P_pop$Region <- factor(gw_20_B_bb_20_P_pop$Region,levels = c("Core", "Margin", "Edge"))

gw_20_B_bb_20_P_pop <- distinct(gw_20_B_bb_20_P_pop)

gw_20_B_bb_20_P_pop$Abs_P <- abs(gw_20_B_bb_20_P_pop$BudBreak2020_Plasticity)
```

### Family plot  

```{r}
gw_20_B_bb_20_P_U <- dplyr::distinct(gw_20_B_bb_20_P, Abs_P,Height_Growth, .keep_all=T)

gw_20_B_bb_20_P_fam_abs_mod <- lm(Height_Growth ~ Abs_P + Region + Abs_P*Region,
                                    data=gw_20_B_bb_20_P_U)
summary(gw_20_B_bb_20_P_fam_abs_mod)
anova(gw_20_B_bb_20_P_fam_abs_mod)
```

- Absolute plasticity is not significant.  
- Absolute plasticity's interaction with Margin region is significant***.  

```{r}
bb_A1 <- sjPlot::plot_model(gw_20_B_bb_20_P_fam_abs_mod, type = "int",  colors=reg_palette) +
                                labs(x = "Absolute plasticity of bud break in 2020 (Family)", y = "Height Growth (BLUP)") + 
                                theme_bw() + theme(axis.text=element_text(size=14), 
                                                 axis.title=element_text(size=18),
                                                 legend.position = "bottom",
                                                 plot.background = element_blank(),
                                                 panel.grid.major = element_blank(),
                                                 panel.grid.minor = element_blank(),
                                                 panel.background = element_blank(),
                                                 plot.title = element_blank())

bb_A <- bb_A1 + geom_point(data=gw_20_B_bb_20_P_U, 
                                           aes(x = abs(BudBreak2020_Plasticity), y = Height_Growth, color = Region, 
                                               shape = Region), size=4, alpha = 0.25, 
                                           inherit.aes = FALSE) 
bb_A
```

### Population plot  

```{r}
gw_20_B_bb_20_P_pop_U <- dplyr::distinct(gw_20_B_bb_20_P_pop, Abs_P,Height_Growth, .keep_all=T)

gw_20_B_bb_20_P_pop_abs_mod <- lm(Height_Growth ~ Abs_P + Region + Abs_P*Region,
                                    data=gw_20_B_bb_20_P_pop_U)
summary(gw_20_B_bb_20_P_pop_abs_mod)
anova(gw_20_B_bb_20_P_pop_abs_mod)
```

- Absolute plasticity is not significant.  
- Absolute plasticity's interaction with Margin region is significant***.  

```{r}
# updated fig for the paper 
bb_B1 <- sjPlot::plot_model(gw_20_B_bb_20_P_pop_abs_mod, type = "int",  colors=reg_palette) +
                                labs(x = "Absolute plasticity of bud break in 2020 (Population)", y = "") + 
                                theme_bw() + theme(axis.text=element_text(size=14), 
                                                 axis.title=element_text(size=18),
                                                 legend.position = "bottom",
                                                 plot.background = element_blank(),
                                                 panel.grid.major = element_blank(),
                                                 panel.grid.minor = element_blank(),
                                                 panel.background = element_blank(),
                                                 plot.title = element_blank()) 

bb_B <- bb_B1 + geom_point(data=gw_20_B_bb_20_P_pop_U, 
                                           aes(x = abs(BudBreak2020_Plasticity), y = Height_Growth, color = Region, 
                                               shape = Region), size=4, alpha = 0.25, 
                                           inherit.aes = FALSE) 

bb_B
```

```{r}
# combined for the paper 
# create legend
test <- ggplot() + geom_point(data=gw_20_B_bb_20_P_U, 
                                           aes(x = abs(BudBreak2020_Plasticity), y = Height_Growth, color = Region, 
                                               shape = Region), size=3, alpha = 1, 
                                           inherit.aes = FALSE) + 
  scale_color_manual(values = c("goldenrod2", "green2", "steelblue")) +
  theme_bw() + theme(axis.text=element_text(size=10), 
                                                 axis.title=element_text(size=12),
                                                 legend.position = "bottom",
                                                 legend.title=element_text(size=21),
                                                 legend.text=element_text(size=20),
                                                 plot.background = element_blank(),
                                                 panel.grid.major = element_blank(),
                                                 panel.grid.minor = element_blank(),
                                                 panel.background = element_blank(),
                                                 plot.title = element_blank()) + 
  guides(color = guide_legend(override.aes = list(size = 8)))

legend_bb <- get_legend(test + theme(legend.position="bottom"))


BB_grid <- cowplot::plot_grid( bb_A + theme(legend.position="none"),
           bb_B + theme(legend.position="none"),
           align = 'vh',
           labels = c("A", "B"),
           hjust = -1,
           nrow = 1
           )
# bud break final 
bb_comb <- cowplot::plot_grid(BB_grid, legend_bb, ncol = 1, rel_heights = c(1,.2))
```


 
## Height growth of 2019 means vs budset 2019 Plasticity  {.tabset .tabset-fade .tabset-pills}  

### Family data  
```{r}
# blups for height growth
heightGrowth_2019_2 <- heightGrowth_2019
heightGrowth_2019_2 <- heightGrowth_2019_2%>% unite(mBed, Garden, Bed, sep = "_", remove = FALSE)

HeightGrowth_2019_mod <- lmer(Growth ~ Garden + (1|mBed) + (1|Family), heightGrowth_2019_2)

# HeightGrowth_2019_blup <- coef(HeightGrowth_2019_mod)

HeightGrowth_2019_blup <- ranef(HeightGrowth_2019_mod)

HeightGrowth_2019_blup <- HeightGrowth_2019_blup$Family
HeightGrowth_2019_blup <- cbind(Family=rownames(HeightGrowth_2019_blup),HeightGrowth_2019_blup)
rownames(HeightGrowth_2019_blup) <- NULL
names(HeightGrowth_2019_blup)[2] <- "Height_Growth"

# plasticity based on budset 2019 
gw_19_B_bs_19_P <- merge(x=HeightGrowth_2019_blup,
                         y=Plasticity[,c("Family","BudSet2019_Plasticity")],
                         by="Family")
# rename plasticity column if needed
# colnames(gw_19_B_bs_19_P)[colnames(gw_19_B_bs_19_P)=="BudSet2019_Plasticity"] <- "BudSet2019_Plasticity"

# remove NAs
gw_19_B_bs_19_P <- gw_19_B_bs_19_P[!is.na(gw_19_B_bs_19_P$BudSet2019_Plasticity),]

# Population column creation
gw_19_B_bs_19_P$Population <- gsub("\\_.*", "", gw_19_B_bs_19_P$Family)

# merge climateNA data
gw_19_B_bs_19_P <- merge(x=gw_19_B_bs_19_P,
                               y=Family_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

# merge Region data
gw_19_B_bs_19_P <- merge(x=gw_19_B_bs_19_P,
                               y=heightGrowth_2019[,c("Population","Region")],
                               by="Population")
# reorder regions
gw_19_B_bs_19_P$Region <- factor(gw_19_B_bs_19_P$Region,levels = c("Core", "Margin", "Edge"))

gw_19_B_bs_19_P <- distinct(gw_19_B_bs_19_P)

gw_19_B_bs_19_P$Abs_P <- abs(gw_19_B_bs_19_P$BudSet2019_Plasticity)
```

### Population data  
```{r}
gw_19_B_bs_19_P$Population <- as.factor(gw_19_B_bs_19_P$Population)

gw_19_B_bs_19_P_pop <- gw_19_B_bs_19_P %>%
                            select(Population, Height_Growth, BudSet2019_Plasticity, Region) %>%
                            group_by(Population) %>%
                            dplyr::summarise(Height_Growth = mean(Height_Growth), BudSet2019_Plasticity = mean(BudSet2019_Plasticity))

gw_19_B_bs_19_P_pop <- merge(x=gw_19_B_bs_19_P_pop,
                               y=Population_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

gw_19_B_bs_19_P_pop <- merge(x=gw_19_B_bs_19_P_pop,
                               y=heightGrowth_2019[,c("Population","Region")],
                               by="Population")
# reorder regions
gw_19_B_bs_19_P_pop$Region <- factor(gw_19_B_bs_19_P_pop$Region,levels = c("Core", "Margin", "Edge"))

gw_19_B_bs_19_P_pop <- distinct(gw_19_B_bs_19_P_pop)

gw_19_B_bs_19_P_pop$Abs_P <- abs(gw_19_B_bs_19_P_pop$BudSet2019_Plasticity)
```

### Family plot  

```{r}
gw_19_B_bs_19_P_U <- dplyr::distinct(gw_19_B_bs_19_P, Abs_P,Height_Growth, .keep_all=T)

gw_19_B_bs_19_P_fam_abs_mod <- lm(Height_Growth ~ Abs_P + Region + Abs_P*Region,
                                    data=gw_19_B_bs_19_P_U)
summary(gw_19_B_bs_19_P_fam_abs_mod)
anova(gw_19_B_bs_19_P_fam_abs_mod)
```

- Absolute plasticity is significant***.  
- Absolute plasticity's interaction with Core and Edge region is significant***.  

```{r}

# updated fig for the paper 


bs_A1 <- sjPlot::plot_model(gw_19_B_bs_19_P_fam_abs_mod, type = "int",  colors=reg_palette) +
                                labs(x = "Absolute plasticity of bud set in 2019 (Family)", y = "Height Growth (BLUP)") + 
                                theme_bw() + theme(axis.text=element_text(size=14), 
                                                 axis.title=element_text(size=18),
                                                 legend.position = "bottom",
                                                 plot.background = element_blank(),
                                                 panel.grid.major = element_blank(),
                                                 panel.grid.minor = element_blank(),
                                                 panel.background = element_blank(),
                                                 plot.title = element_blank()) 

bs_A <- bs_A1 + geom_point(data=gw_19_B_bs_19_P_U, 
                                           aes(x = abs(BudSet2019_Plasticity), y = Height_Growth, color = Region, 
                                               shape = Region), size=4, alpha = 0.25, 
                                           inherit.aes = FALSE) 


bs_A
```

### Population plot  

```{r}
gw_19_B_bs_19_P_pop_U <- dplyr::distinct(gw_19_B_bs_19_P_pop, Abs_P,Height_Growth, .keep_all=T)

gw_19_B_bs_19_P_pop_abs_mod <- lm(Height_Growth ~ Abs_P + Region + Abs_P*Region,
                                    data=gw_19_B_bs_19_P_pop_U)
summary(gw_19_B_bs_19_P_pop_abs_mod)
anova(gw_19_B_bs_19_P_pop_abs_mod)
```

- Absolute plasticity is significant*.  
- Absolute plasticity's interaction with Core*** and Edge* region is significant***.  

```{r}
# updated fig for the paper 
bs_B1 <- sjPlot::plot_model(gw_19_B_bs_19_P_pop_abs_mod, type = "int",  colors=reg_palette) +
                                labs(x = "Absolute plasticity of bud set in 2019 (Population)", y = "") + 
                                theme_bw() + theme(axis.text=element_text(size=14), 
                                                 axis.title=element_text(size=18),
                                                 legend.position = "bottom",
                                                 plot.background = element_blank(),
                                                 panel.grid.major = element_blank(),
                                                 panel.grid.minor = element_blank(),
                                                 panel.background = element_blank(),
                                                 plot.title = element_blank()) 

bs_B <- bs_B1 + geom_point(data=gw_19_B_bs_19_P_pop_U, 
                                           aes(x = abs(BudSet2019_Plasticity), y = Height_Growth, color = Region, 
                                               shape = Region), size=4, alpha = 0.25, 
                                           inherit.aes = FALSE) 

bs_B
```

## Height growth of 2020 means vs budset 2020 Plasticity  {.tabset .tabset-fade .tabset-pills}   
### Family data  
```{r}
# blups for height growth
heightGrowth_2020_2 <- heightGrowth_2020
heightGrowth_2020_2 <- heightGrowth_2020_2 %>% unite(mBed, Garden, Bed, sep = "_", remove = FALSE)

HeightGrowth_2020_mod <- lmer(Growth ~ Garden + (1|mBed) + (1|Family), heightGrowth_2020_2)

HeightGrowth_2020_blup <- ranef(HeightGrowth_2020_mod)
HeightGrowth_2020_blup <- HeightGrowth_2020_blup$Family
HeightGrowth_2020_blup <- cbind(Family=rownames(HeightGrowth_2020_blup),HeightGrowth_2020_blup)
rownames(HeightGrowth_2020_blup) <- NULL
names(HeightGrowth_2020_blup)[2] <- "Height_Growth"

# plasticity based on budset 2020 
gw_20_B_bs_20_P <- merge(x=HeightGrowth_2020_blup,
                         y=Plasticity[,c("Family","BudSet2020_Plasticity")],
                         by="Family")
# rename plasticity column if needed
colnames(gw_20_B_bs_20_P)[colnames(gw_20_B_bs_20_P)=="BudSet2020_Plasticity"] <- "BudSet2020_Plasticity"

# remove NAs
gw_20_B_bs_20_P <- gw_20_B_bs_20_P[!is.na(gw_20_B_bs_20_P$BudSet2020_Plasticity),]

# Population column creation
gw_20_B_bs_20_P$Population <- gsub("\\_.*", "", gw_20_B_bs_20_P$Family)

# merge climateNA data
gw_20_B_bs_20_P <- merge(x=gw_20_B_bs_20_P,
                               y=Family_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

# merge Region data
gw_20_B_bs_20_P <- merge(x=gw_20_B_bs_20_P,
                               y=heightGrowth_2020[,c("Population","Region")],
                               by="Population")
# reorder regions
gw_20_B_bs_20_P$Region <- factor(gw_20_B_bs_20_P$Region,levels = c("Core", "Margin", "Edge"))

gw_20_B_bs_20_P <- distinct(gw_20_B_bs_20_P)

gw_20_B_bs_20_P$Abs_P <- abs(gw_20_B_bs_20_P$BudSet2020_Plasticity)
```

### Population data  
```{r}
gw_20_B_bs_20_P$Population <- as.factor(gw_20_B_bs_20_P$Population)

gw_20_B_bs_20_P_pop <- gw_20_B_bs_20_P %>%
                            select(Population, Height_Growth, BudSet2020_Plasticity, Region) %>%
                            group_by(Population) %>%
                            dplyr::summarise(Height_Growth = mean(Height_Growth), BudSet2020_Plasticity = mean(BudSet2020_Plasticity))

gw_20_B_bs_20_P_pop <- merge(x=gw_20_B_bs_20_P_pop,
                               y=Population_climateNA[,c("Population","PC1","MAT")],
                               by="Population")

gw_20_B_bs_20_P_pop <- merge(x=gw_20_B_bs_20_P_pop,
                               y=heightGrowth_2019[,c("Population","Region")],
                               by="Population")
# reorder regions
gw_20_B_bs_20_P_pop$Region <- factor(gw_20_B_bs_20_P_pop$Region,levels = c("Core", "Margin", "Edge"))

gw_20_B_bs_20_P_pop <- distinct(gw_20_B_bs_20_P_pop)

gw_20_B_bs_20_P_pop$Abs_P <- abs(gw_20_B_bs_20_P_pop$BudSet2020_Plasticity)
```

### Family plot  

```{r}
gw_20_B_bs_20_P_U <- dplyr::distinct(gw_20_B_bs_20_P, Abs_P,Height_Growth, .keep_all=T)

gw_20_B_bs_20_P_fam_abs_mod <- lm(Height_Growth ~ Abs_P + Region + Abs_P*Region,
                                    data=gw_20_B_bs_20_P_U)
summary(gw_20_B_bs_20_P_fam_abs_mod)
anova(gw_20_B_bs_20_P_fam_abs_mod)
```

- Absolute plasticity is significant***.  
- Absolute plasticity's interaction with Core, Margin and Edge region is significant***.  

```{r}
# updated fig for the paper 
bs_C1 <- sjPlot::plot_model(gw_20_B_bs_20_P_fam_abs_mod, type = "int",  colors=reg_palette) +
                                labs(x = "Absolute plasticity of bud set in 2020 (Family)", y = "Height Growth (BLUP)") + 
                                theme_bw() + theme(axis.text=element_text(size=14), 
                                                 axis.title=element_text(size=18),
                                                 legend.position = "bottom",
                                                 plot.background = element_blank(),
                                                 panel.grid.major = element_blank(),
                                                 panel.grid.minor = element_blank(),
                                                 panel.background = element_blank(),
                                                 plot.title = element_blank()) 

bs_C <- bs_C1 + geom_point(data=gw_20_B_bs_20_P_U, 
                                           aes(x = abs(BudSet2020_Plasticity), y = Height_Growth, color = Region, 
                                               shape = Region), size=4, alpha = 0.25, 
                                           inherit.aes = FALSE) 

bs_C
```

### Population plot   

```{r}
gw_20_B_bs_20_P_pop_U <- dplyr::distinct(gw_20_B_bs_20_P_pop, Abs_P,Height_Growth, .keep_all=T)

gw_20_B_bs_20_P_pop_abs_mod <- lm(Height_Growth ~ Abs_P + Region + Abs_P*Region,
                                    data=gw_20_B_bs_20_P_pop_U)
summary(gw_20_B_bs_20_P_pop_abs_mod)
anova(gw_20_B_bs_20_P_pop_abs_mod)
```

- Absolute plasticity is significant**.  
- Absolute plasticity's interaction with Core, Margin and Edge region is significant**.  

```{r}
# updated fig for the paper 
bs_D1 <- sjPlot::plot_model(gw_20_B_bs_20_P_pop_abs_mod, type = "int",  colors=reg_palette) +
                                labs(x = "Absolute plasticity of bud set in 2020 (Population)", y = "") + 
                                theme_bw() + theme(axis.text=element_text(size=14), 
                                                 axis.title=element_text(size=18),
                                                 legend.position = "bottom",
                                                 plot.background = element_blank(),
                                                 panel.grid.major = element_blank(),
                                                 panel.grid.minor = element_blank(),
                                                 panel.background = element_blank(),
                                                 plot.title = element_blank()) 

bs_D <- bs_D1 + geom_point(data=gw_20_B_bs_20_P_pop_U, 
                                           aes(x = abs(BudSet2020_Plasticity), y = Height_Growth, color = Region, 
                                               shape = Region), size=4, alpha = 0.25, 
                                           inherit.aes = FALSE) 

bs_D
```

```{r}
# combined for the paper 

# create legend
legend_bb <- get_legend(test + theme(legend.position="bottom"))


BS_grid <- cowplot::plot_grid( bs_A + theme(legend.position="none"),
           bs_B + theme(legend.position="none"),
           bs_C + theme(legend.position="none"),
           bs_D + theme(legend.position="none"),
           align = 'vh',
           labels = c("A", "B", "C", "D"),
           hjust = -1,
           nrow = 2
           )
# bud set final 
bs_plot <- cowplot::plot_grid(BS_grid, legend_bb, ncol = 1, rel_heights = c(1,.2))
```

