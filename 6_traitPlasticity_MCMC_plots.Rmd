---
title: "Trait plasticity based on climate transfer distance"
author: "Anoob Prakash"
date: "02/03/2021"
output:
  rmarkdown::html_document:
    theme: cosmo  
    number_sections: false
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## notes  
gw - growth  
bb - budbreak  
bs - budset  
B - lmer family blups (means)  
P - plasticity value for the trait 

# packages
```{r}
require(ggplot2)
require(lmerTest)
require(dplyr)
require(tidyr)
require(MCMCglmm)
require(plyr)
require(viridis)
```


```{r}
# setwd("Z:/Anoob/MCMCglmm")

# exome data
exome_meta <- read.table("./Exome/RS_Exome_metadata.txt", sep="\t", header = T)

# climateNA
climateNA <- readxl::read_xlsx("./ClimateNA/spruce_envVar_PCA_210118.xlsx")
colnames(climateNA)[colnames(climateNA)=="site"] <- "Population"
```

# Height growth  
## Height growth of 2019 - Means vs Plasticity  
```{r}
# read the output
gw_19_B_gw_19_P_corr <- readRDS("./plasticity_outputs/gw_19_B_gw_19_P_corr")
# plot(gw_19_B_gw_19_P_corr)

effectiveSize(gw_19_B_gw_19_P_corr$VCV)
heidel.diag(gw_19_B_gw_19_P_corr$VCV)

## setting up dataframe for correlation based on the model blups
gw_19_B_gw_19_P_coefs <- data_frame(Trait = attr(colMeans(gw_19_B_gw_19_P_corr$Sol), "names"),
                                    Value = colMeans(gw_19_B_gw_19_P_corr$Sol)) %>%
  separate(Trait, c("Trait","Type","Population"), sep = "\\.", fill = "right") %>%
  filter(Type == "Population") %>%
  filter(Trait %in% c("traitHeight_Growth", "traitPlasticity")) %>%
  select(-Type) %>%
  spread(Trait, Value)

gw_19_B_gw_19_P_coefs <-  merge(x=gw_19_B_gw_19_P_coefs,
                                y=exome_meta[,c("Pop","Region")],
                                all.x=T,
                                by.x="Population",
                                by.y="Pop")


# Find the regression line -
# the covariance of growth, plasticity divided by
# the variance in plasticity
gw_19_B_gw_19_P_fit_slope <- mean(gw_19_B_gw_19_P_corr$VCV[,"traitHeight_Growth:traitPlasticity.Population"]/
  gw_19_B_gw_19_P_corr$VCV[,"traitPlasticity:traitPlasticity.Population"])

# rename regions
gw_19_B_gw_19_P_coefs$Region <- revalue(gw_19_B_gw_19_P_coefs$Region, c("C"="Core", "M"="Margin","E"="Edge")) 
# reorder regions
gw_19_B_gw_19_P_coefs$Region <- factor(gw_19_B_gw_19_P_coefs$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
gw_19_B_gw_19_P_coefs <- merge(x=gw_19_B_gw_19_P_coefs,
                               y=climateNA[,c("Population","PC1","MAT")],
                               by="Population")

cor.test(gw_19_B_gw_19_P_coefs$traitPlasticity,gw_19_B_gw_19_P_coefs$traitHeight_Growth)

# plot
ggplot(gw_19_B_gw_19_P_coefs, aes(x = traitPlasticity, y = traitHeight_Growth, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  # geom_abline(intercept = 0, slope = mean(gw_19_B_gw_19_P_fit_slope)) + 
  labs(x = "Plasticity of Height Growth in 2019 (BLUP)", y = "Height Growth in 2019 (BLUP)") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) +
  annotate("text", label = "Correlation between traits: 0.822", x = 0.25, y = -1.3)
```

## Height growth of 2020 - Means vs Plasticity  
```{r}
# read the output
gw_20_B_gw_20_P_corr <- readRDS("./plasticity_outputs/gw_20_B_gw_20_P_corr")
# plot(gw_20_B_gw_20_P_corr)
effectiveSize(gw_20_B_gw_20_P_corr$VCV)
heidel.diag(gw_20_B_gw_20_P_corr$VCV)

## setting up dataframe for correlation based on the model blups
gw_20_B_gw_20_P_coefs <- data_frame(Trait = attr(colMeans(gw_20_B_gw_20_P_corr$Sol), "names"),
                                    Value = colMeans(gw_20_B_gw_20_P_corr$Sol)) %>%
  separate(Trait, c("Trait","Type","Population"), sep = "\\.", fill = "right") %>%
  filter(Type == "Population") %>%
  filter(Trait %in% c("traitHeight_Growth", "traitPlasticity")) %>%
  select(-Type) %>%
  spread(Trait, Value)

gw_20_B_gw_20_P_coefs <-  merge(x=gw_20_B_gw_20_P_coefs,
                                y=exome_meta[,c("Pop","Region")],
                                all.x=T,
                                by.x="Population",
                                by.y="Pop")

# Find the regression line -
# the covariance of growth, plasticity divided by
# the variance in plasticity
gw_20_B_gw_20_P_fit_slope <- mean(gw_20_B_gw_20_P_corr$VCV[,"traitHeight_Growth:traitPlasticity.Population"]/
  gw_20_B_gw_20_P_corr$VCV[,"traitPlasticity:traitPlasticity.Population"])


# rename regions
gw_20_B_gw_20_P_coefs$Region <- revalue(gw_20_B_gw_20_P_coefs$Region, c("C"="Core", "M"="Margin","E"="Edge")) 
# reorder regions
gw_20_B_gw_20_P_coefs$Region <- factor(gw_20_B_gw_20_P_coefs$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
gw_20_B_gw_20_P_coefs <- merge(x=gw_20_B_gw_20_P_coefs,
                               y=climateNA[,c("Population","PC1","MAT")],
                               by="Population")

cor.test(gw_20_B_gw_20_P_coefs$traitPlasticity,gw_20_B_gw_20_P_coefs$traitHeight_Growth)

# plot
ggplot(gw_20_B_gw_20_P_coefs, aes(x = traitPlasticity, y = traitHeight_Growth, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  # geom_abline(intercept = 0, slope = mean(gw_20_B_gw_20_P_fit_slope)) + 
  labs(x = "Plasticity of Height Growth in 2020 (BLUP)", y = "Height Growth in 2020 (BLUP)") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) +
  annotate("text", label = "Correlation between traits: -0.912", x = -1, y = -0.8)
```

# Growth vs Phenology  
## Height growth vs budbreak  
### Height growth of 2019 means vs budbreak 2020 Plasticity  
```{r}
#read the output
gw_19_B_bb_20_P_corr <- readRDS("./plasticity_outputs/gw_19_B_bb_20_P_corr")

# plot(gw_19_B_bb_20_P_corr)
effectiveSize(gw_19_B_bb_20_P_corr$VCV)
heidel.diag(gw_19_B_bb_20_P_corr$VCV) # failed

## setting up dataframe for correlation based on the model blups
gw_19_B_bb_20_P_coefs <- data_frame(Trait = attr(colMeans(gw_19_B_bb_20_P_corr$Sol), "names"),
                                    Value = colMeans(gw_19_B_bb_20_P_corr$Sol)) %>%
  separate(Trait, c("Trait","Type","Population"), sep = "\\.", fill = "right") %>%
  filter(Type == "Population") %>%
  filter(Trait %in% c("traitHeight_Growth", "traitBudBreak2020_Plasticity")) %>%
  select(-Type) %>%
  spread(Trait, Value)

gw_19_B_bb_20_P_coefs <-  merge(x=gw_19_B_bb_20_P_coefs,
                                y=exome_meta[,c("Pop","Region")],
                                all.x=T,
                                by.x="Population",
                                by.y="Pop")

# Find the regression line -
# the covariance of growth, plasticity divided by
# the variance in plasticity
gw_19_B_bb_20_P_fit_slope <- mean(gw_19_B_bb_20_P_corr$VCV[,"traitHeight_Growth:traitBudBreak2020_Plasticity.Population"]/
  gw_19_B_bb_20_P_corr$VCV[,"traitBudBreak2020_Plasticity:traitBudBreak2020_Plasticity.Population"])

# rename regions
gw_19_B_bb_20_P_coefs$Region <- revalue(gw_19_B_bb_20_P_coefs$Region, c("C"="Core", "M"="Margin","E"="Edge")) 
# reorder regions
gw_19_B_bb_20_P_coefs$Region <- factor(gw_19_B_bb_20_P_coefs$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
gw_19_B_bb_20_P_coefs <- merge(x=gw_19_B_bb_20_P_coefs,
                               y=climateNA[,c("Population","PC1","MAT")],
                               by="Population")

cor.test(gw_19_B_bb_20_P_coefs$traitBudBreak2020_Plasticity,gw_19_B_bb_20_P_coefs$traitHeight_Growth)
# plot
ggplot(gw_19_B_bb_20_P_coefs, aes(x = traitBudBreak2020_Plasticity, y = traitHeight_Growth, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  # geom_abline(intercept = 0, slope = mean(gw_19_B_bb_20_P_fit_slope)) + 
  labs(x = "Plasticity of Bud break in 2020 (BLUP)", y = "Height Growth in 2019 (BLUP)") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) +
  annotate("text", label = "Correlation between traits: -0.279", x = 0.9, y = -1.3)
```

### Height growth of 2020 means vs budbreak 2020 Plasticity  
```{r}
# read the output
gw_20_B_bb_20_P_corr <- readRDS("./plasticity_outputs/gw_20_B_bb_20_P_corr")
# plot(gw_20_B_bb_20_P_corr)
effectiveSize(gw_20_B_bb_20_P_corr$VCV)
heidel.diag(gw_20_B_bb_20_P_corr$VCV)

## setting up dataframe for correlation based on the model blups
gw_20_B_bb_20_P_coefs <- data_frame(Trait = attr(colMeans(gw_20_B_bb_20_P_corr$Sol), "names"),
                                    Value = colMeans(gw_20_B_bb_20_P_corr$Sol)) %>%
  separate(Trait, c("Trait","Type","Population"), sep = "\\.", fill = "right") %>%
  filter(Type == "Population") %>%
  filter(Trait %in% c("traitHeight_Growth", "traitBudBreak2020_Plasticity")) %>%
  select(-Type) %>%
  spread(Trait, Value)

gw_20_B_bb_20_P_coefs <-  merge(x=gw_20_B_bb_20_P_coefs,
                                y=exome_meta[,c("Pop","Region")],
                                all.x=T,
                                by.x="Population",
                                by.y="Pop")


# Find the regression line -
# the covariance of growth, plasticity divided by
# the variance in plasticity
gw_20_B_bb_20_P_fit_slope <- mean(gw_20_B_bb_20_P_corr$VCV[,"traitHeight_Growth:traitBudBreak2020_Plasticity.Population"]/
  gw_20_B_bb_20_P_corr$VCV[,"traitBudBreak2020_Plasticity:traitBudBreak2020_Plasticity.Population"])

# rename regions
gw_20_B_bb_20_P_coefs$Region <- revalue(gw_20_B_bb_20_P_coefs$Region, c("C"="Core", "M"="Margin","E"="Edge")) 
# reorder regions
gw_20_B_bb_20_P_coefs$Region <- factor(gw_20_B_bb_20_P_coefs$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
gw_20_B_bb_20_P_coefs <- merge(x=gw_20_B_bb_20_P_coefs,
                               y=climateNA[,c("Population","PC1","MAT")],
                               by="Population")

cor.test(gw_20_B_bb_20_P_coefs$traitBudBreak2020_Plasticity,gw_20_B_bb_20_P_coefs$traitHeight_Growth)

# plot
ggplot(gw_20_B_bb_20_P_coefs, aes(x = traitBudBreak2020_Plasticity, y = traitHeight_Growth, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) +
  scale_color_viridis(option = "A", direction = -1) +
  # geom_abline(intercept = 0, slope = mean(gw_20_B_bb_20_P_fit_slope)) + 
  labs(x = "Plasticity of Bud break in 2020 Plasticity (BLUP)", y = "Height Growth in 2020 (BLUP)") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) +
  annotate("text", label = "Correlation between traits: 0.571", x = 1, y = -0.8)
```

## Height growth vs budset  
### Height growth of 2019 means vs budset 2019 Plasticity  
```{r}
# read the output
gw_19_B_bs_19_P_corr <- readRDS("./plasticity_outputs/gw_19_B_bs_19_P_corr")
# plot(gw_19_B_bs_19_P_corr)
effectiveSize(gw_19_B_bs_19_P_corr$VCV)
heidel.diag(gw_19_B_bs_19_P_corr$VCV)

## setting up dataframe for correlation based on the model blups
gw_19_B_bs_19_P_coefs <- data_frame(Trait = attr(colMeans(gw_19_B_bs_19_P_corr$Sol), "names"),
                                    Value = colMeans(gw_19_B_bs_19_P_corr$Sol)) %>%
  separate(Trait, c("Trait","Type","Population"), sep = "\\.", fill = "right") %>%
  filter(Type == "Population") %>%
  filter(Trait %in% c("traitHeight_Growth", "traitBudSet2019_Plasticity")) %>%
  select(-Type) %>%
  spread(Trait, Value)

gw_19_B_bs_19_P_coefs <-  merge(x=gw_19_B_bs_19_P_coefs,
                                y=exome_meta[,c("Pop","Region")],
                                all.x=T,
                                by.x="Population",
                                by.y="Pop")


# Find the regression line -
# the covariance of growth, plasticity divided by
# the variance in plasticity
gw_19_B_bs_19_P_fit_slope <- mean(gw_19_B_bs_19_P_corr$VCV[,"traitHeight_Growth:traitBudSet2019_Plasticity.Population"]/
  gw_19_B_bs_19_P_corr$VCV[,"traitBudSet2019_Plasticity:traitBudSet2019_Plasticity.Population"])

# rename regions
gw_19_B_bs_19_P_coefs$Region <- revalue(gw_19_B_bs_19_P_coefs$Region, c("C"="Core", "M"="Margin","E"="Edge")) 
# reorder regions
gw_19_B_bs_19_P_coefs$Region <- factor(gw_19_B_bs_19_P_coefs$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
gw_19_B_bs_19_P_coefs <- merge(x=gw_19_B_bs_19_P_coefs,
                               y=climateNA[,c("Population","PC1","MAT")],
                               by="Population")

cor.test(gw_19_B_bs_19_P_coefs$traitBudSet2019_Plasticity,gw_19_B_bs_19_P_coefs$traitHeight_Growth)

# plot
ggplot(gw_19_B_bs_19_P_coefs, aes(x = traitBudSet2019_Plasticity, y = traitHeight_Growth, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) +
  scale_color_viridis(option = "A", direction = -1) +
  # geom_point(alpha = 0.7) + 
  # geom_abline(intercept = 0, slope = mean(gw_19_B_bs_19_P_fit_slope)) + 
  labs(x = "Bud set 2019 Plasticity (BLUP)", y = "Height Growth in 2019 (BLUP)") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) +
  annotate("text", label = "Correlation between traits: 0.223", x = 0.45, y = -1.3)
```

### Height growth of 2020 means vs budset 2020 Plasticity   
```{r}
# read the output
gw_20_B_bs_20_P_corr <- readRDS("./plasticity_outputs/gw_20_B_bs_20_P_corr")

# plot(gw_20_B_bs_20_P_corr)
effectiveSize(gw_20_B_bs_20_P_corr$VCV)
heidel.diag(gw_20_B_bs_20_P_corr$VCV)

## setting up dataframe for correlation based on the model blups
gw_20_B_bs_20_P_coefs <- data_frame(Trait = attr(colMeans(gw_20_B_bs_20_P_corr$Sol), "names"),
                                    Value = colMeans(gw_20_B_bs_20_P_corr$Sol)) %>%
  separate(Trait, c("Trait","Type","Population"), sep = "\\.", fill = "right") %>%
  filter(Type == "Population") %>%
  filter(Trait %in% c("traitHeight_Growth", "traitBudSet2020_Plasticity")) %>%
  select(-Type) %>%
  spread(Trait, Value)

gw_20_B_bs_20_P_coefs <-  merge(x=gw_20_B_bs_20_P_coefs,
                                y=exome_meta[,c("Pop","Region")],
                                all.x=T,
                                by.x="Population",
                                by.y="Pop")


# Find the regression line -
# the covariance of growth (fitness), plasticity divided by
# the variance in plasticity
gw_20_B_bs_20_P_fit_slope <- mean(gw_20_B_bs_20_P_corr$VCV[,"traitBudSet2020_Plasticity:traitHeight_Growth.Population"]/
  gw_20_B_bs_20_P_corr$VCV[,"traitBudSet2020_Plasticity:traitBudSet2020_Plasticity.Population"])

# the regression line is based on covariance, and the value seem to positive instead of negative
# however the value is very close to the corr estimate, so I am thinking its just a matter of sign switching
gw_20_B_bs_20_P_fit_slope <- gw_20_B_bs_20_P_fit_slope*(-1) 

# rename regions
gw_20_B_bs_20_P_coefs$Region <- revalue(gw_20_B_bs_20_P_coefs$Region, c("C"="Core", "M"="Margin","E"="Edge")) 
# reorder regions
gw_20_B_bs_20_P_coefs$Region <- factor(gw_20_B_bs_20_P_coefs$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
gw_20_B_bs_20_P_coefs <- merge(x=gw_20_B_bs_20_P_coefs,
                               y=climateNA[,c("Population","PC1","MAT")],
                               by="Population")

cor.test(gw_20_B_bs_20_P_coefs$traitBudSet2020_Plasticity,gw_20_B_bs_20_P_coefs$traitHeight_Growth)

# plot
ggplot(gw_20_B_bs_20_P_coefs, aes(x = traitBudSet2020_Plasticity, y = traitHeight_Growth, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  # geom_abline(intercept = 0, slope = mean(gw_20_B_bs_20_P_fit_slope)) +
  # geom_smooth(method='lm') +
  geom_line() +
  labs(x = "Plasticity of Bud set in 2020 (BLUP)", y = "Height Growth in 2020 (BLUP)") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) +
  annotate("text", label = "Correlation between traits: -0.071", x = 0.10, y = -1)
```

# Phenology vs Phenology  
## Bud break of 2020 Plasticity vs Bud set 2020 Plasticity  
```{r}
# read the output
bb_20_P_bs_20_P_corr <- readRDS("./plasticity_outputs/bb_20_P_bs_20_P_corr")

# plot(bb_20_P_bs_20_P_corr)
effectiveSize(bb_20_P_bs_20_P_corr$VCV)
heidel.diag(bb_20_P_bs_20_P_corr$VCV)

## setting up dataframe for correlation based on the model blups
bb_20_P_bs_20_P_coefs <- data_frame(Trait = attr(colMeans(bb_20_P_bs_20_P_corr$Sol), "names"),
                                    Value = colMeans(bb_20_P_bs_20_P_corr$Sol)) %>%
  separate(Trait, c("Trait","Type","Population"), sep = "\\.", fill = "right") %>%
  filter(Type == "Population") %>%
  filter(Trait %in% c("traitBudBreak2020", "traitBudSet2020")) %>%
  select(-Type) %>%
  spread(Trait, Value)

bb_20_P_bs_20_P_coefs <-  merge(x=bb_20_P_bs_20_P_coefs,
                                y=exome_meta[,c("Pop","Region")],
                                all.x=T,
                                by.x="Population",
                                by.y="Pop")


# Find the regression line -
# the covariance of growth (fitness), plasticity divided by
# the variance in plasticity
bb_20_P_bs_20_P_fit_slope <- mean(bb_20_P_bs_20_P_corr$VCV[,"traitBudBreak2020:traitBudSet2020.Population"]/
                                    bb_20_P_bs_20_P_corr$VCV[,"traitBudBreak2020:traitBudBreak2020.Population"])


# rename regions
bb_20_P_bs_20_P_coefs$Region <- revalue(bb_20_P_bs_20_P_coefs$Region, c("C"="Core", "M"="Margin","E"="Edge")) 
# reorder regions
bb_20_P_bs_20_P_coefs$Region <- factor(bb_20_P_bs_20_P_coefs$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
bb_20_P_bs_20_P_coefs <- merge(x=bb_20_P_bs_20_P_coefs,
                               y=climateNA[,c("Population","PC1","MAT")],
                               by="Population")

cor.test(bb_20_P_bs_20_P_coefs$traitBudBreak2020,bb_20_P_bs_20_P_coefs$traitBudSet2020)

# plot
ggplot(bb_20_P_bs_20_P_coefs, aes(x = traitBudBreak2020, y = traitBudSet2020, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  # geom_abline(intercept = 0, slope = mean(bb_20_P_bs_20_P_fit_slope)) +
  # geom_smooth(method='lm') +
  geom_line() +
  labs(x = "Plasticity of Bud break in 2020 (BLUP)", y = "Plasticity of Bud set in 2020 (BLUP)") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) +
  annotate("text", label = "Correlation between traits: 0.28", x = 0.80, y = -4.8)
```

## Bud break of 2020 Plasticity vs Bud set 2019 Plasticity  
```{r}
# read the output  
bb_20_P_bs_19_P_corr <- readRDS("./plasticity_outputs/bb_20_P_bs_19_P_corr")

# plot(bb_20_P_bs_19_P_corr)
effectiveSize(bb_20_P_bs_19_P_corr$VCV)
heidel.diag(bb_20_P_bs_19_P_corr$VCV)

## setting up dataframe for correlation based on the model blups
bb_20_P_bs_19_P_coefs <- data_frame(Trait = attr(colMeans(bb_20_P_bs_19_P_corr$Sol), "names"),
                                    Value = colMeans(bb_20_P_bs_19_P_corr$Sol)) %>%
  separate(Trait, c("Trait","Type","Population"), sep = "\\.", fill = "right") %>%
  filter(Type == "Population") %>%
  filter(Trait %in% c("traitBudBreak2020", "traitBudSet2019")) %>%
  select(-Type) %>%
  spread(Trait, Value)

bb_20_P_bs_19_P_coefs <-  merge(x=bb_20_P_bs_19_P_coefs,
                                y=exome_meta[,c("Pop","Region")],
                                all.x=T,
                                by.x="Population",
                                by.y="Pop")


# Find the regression line -
# the covariance of growth (fitness), plasticity divided by
# the variance in plasticity
bb_20_P_bs_19_P_fit_slope <- mean(bb_20_P_bs_19_P_corr$VCV[,"traitBudBreak2020:traitBudSet2019.Population"]/
                                    bb_20_P_bs_19_P_corr$VCV[,"traitBudBreak2020:traitBudBreak2020.Population"])


# rename regions
bb_20_P_bs_19_P_coefs$Region <- revalue(bb_20_P_bs_19_P_coefs$Region, c("C"="Core", "M"="Margin","E"="Edge")) 
# reorder regions
bb_20_P_bs_19_P_coefs$Region <- factor(bb_20_P_bs_19_P_coefs$Region,levels = c("Core", "Margin", "Edge"))

# merge climateNA data
bb_20_P_bs_19_P_coefs <- merge(x=bb_20_P_bs_19_P_coefs,
                               y=climateNA[,c("Population","PC1","MAT")],
                               by="Population")

cor.test(bb_20_P_bs_19_P_coefs$traitBudBreak2020,bb_20_P_bs_19_P_coefs$traitBudSet2019)

# plot
ggplot(bb_20_P_bs_19_P_coefs, aes(x = traitBudSet2019, y = traitBudBreak2020, group = Population, color = PC1)) +
  geom_point(aes(shape = Region), size=3, alpha = 0.7) + 
  scale_color_viridis(option = "A", direction = -1) +
  geom_line() +
  labs(x = "Plasticity of Bud set in 2019 (BLUP)", y = "Plasticity of Bud break in 2020 (BLUP)") + 
  theme_bw() + theme(axis.text=element_text(size=14), 
                     axis.title=element_text(size=14,face="bold"),
                     legend.title = element_text(color = "black", size = 14),
                     legend.text = element_text(color = "black", size = 13)) +
  annotate("text", label = "Correlation between traits: 0.531", x = 0.5, y = -1.2)

```

