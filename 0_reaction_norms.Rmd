---
title: "NSF Red Spruce common garden reaction norms (2019-20)"
author: "Anoob Prakash"
date: "16/11/2020"
output:
  rmarkdown::html_document:
    theme: cosmo  
    number_sections: false
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r message=FALSE, warning=FALSE, paged.print=FALSE}
suppressPackageStartupMessages({
require(tidyr)
require(lme4) # for running models
require(sjPlot) # for visualizing model interactions
require(sjmisc)
require(sjlabelled)
require(tidyverse)
require(viridis)
require(lmerTest)
require(cowplot)
})
```

# Climate data  
```{r}
Population_climateNA <- read.csv("C:/Dropbox/UVM/Research/Code/ClimateData/ClimateNA/Family/PCA_sprucePops.txt",
                                 header=T, sep="\t")
colnames(Population_climateNA)[colnames(Population_climateNA)=="PC1_sel"] <- "PC1"

Family_climateNA <- read.csv("C:/Dropbox/UVM/Research/Code/ClimateData/ClimateNA/Family/PCA_spruceFams.txt",
                                 header=T, sep="\t")
colnames(Family_climateNA)[colnames(Family_climateNA)=="PC1_sel"] <- "PC1"
```

# Trait data   
```{r}
budset_2019 <- read.csv("./trait_data/BudSet_2019.csv", stringsAsFactors = T)
budset_2020 <- read.csv("./trait_data/BudSet_2020.csv", stringsAsFactors = T)
budbreak_2020 <- read.csv("./trait_data/BudBreak_2020_cGDD.csv", stringsAsFactors = T)
growth_2019 <- read.csv("./trait_data/Growth_2019.csv", stringsAsFactors = T)
growth_2020 <- read.csv("./trait_data/Growth_2020.csv", stringsAsFactors = T)
Plasticity <- read.csv("./trait_data/Plasticity.csv", stringsAsFactors = T)
```

* Reorder levels  
```{r}
# Garden  
budset_2019$Garden <-  factor(budset_2019$Garden,levels = c("Vermont", "Maryland", "North_Carolina"))
budset_2020$Garden <-  factor(budset_2020$Garden,levels = c("Vermont", "Maryland", "North_Carolina"))
budbreak_2020$Garden <-  factor(budbreak_2020$Garden,levels = c("Vermont", "Maryland", "North_Carolina"))
growth_2019$Garden <-  factor(growth_2019$Garden,levels = c("Vermont", "Maryland", "North_Carolina"))
growth_2020$Garden <-  factor(growth_2020$Garden,levels = c("Vermont", "Maryland", "North_Carolina"))

# Region
budset_2019$Region <-  factor(budset_2019$Region,levels = c("Core", "Margin", "Edge"))
budset_2020$Region <-  factor(budset_2020$Region,levels = c("Core", "Margin", "Edge"))
budbreak_2020$Region <-  factor(budbreak_2020$Region,levels = c("Core", "Margin", "Edge"))
growth_2019$Region <-  factor(growth_2019$Region,levels = c("Core", "Margin", "Edge"))
growth_2020$Region <-  factor(growth_2020$Region,levels = c("Core", "Margin", "Edge"))

```



# Models  {.tabset .tabset-fade .tabset-pills}  

## Growth 2019     
```{r}
## working model for growth - ****
Growth19_mod1 <- lmer(data = growth_2019, na.action = na.omit,
               Growth ~ Garden * Region +
               (1|Population) + (1|mBed) +
               (Garden|Family)) # G x E

Growth19_mod1a <- lmer(data = growth_2019, na.action = na.omit,
               Growth ~ Garden * Region +
               (1|Population) + (1|mBed) + (1|Family))

Growth19_mod1b <- lmer(data = growth_2019, na.action = na.omit,
               Growth ~ Garden * Region +
               (1|Population) + (1|mBed))

# model 1 anova 
anova(Growth19_mod1)

# impact of GxE
anova(Growth19_mod1, Growth19_mod1a) 

# effect of genotype
anova(Growth19_mod1a, Growth19_mod1b)

# model 1 vs 3
anova(Growth19_mod1, Growth19_mod1b)

# the effect of genotype has higher magnitude of significance compared to the 
# effect of GxE

# GxE is of higher magnitude effect when not accounting for family
anova(Growth19_mod1, Growth19_mod1b)

# LRT 
anova(Growth19_mod1,Growth19_mod1a,Growth19_mod1b)

# AIC
AIC(Growth19_mod1,Growth19_mod1a,Growth19_mod1b)


# effect size estimates for growth trait
plot_model(Growth19_mod1, vline.color = "red", sort.est=TRUE, show.values = T, value.offset = .3) + 
  theme_minimal() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12,face="bold"),
        strip.text.x = element_text(size = 12, colour = "black", angle = 0, face="bold"))
```

```{r}
# diagnostic tests for the model
# sjPlot::plot_model(Growth19_mod1, type = "diag")

tab_model(Growth19_mod1)
```

## Growth 2020     
```{r}
## working model for growth - ****
Growth_mod1 <- lmer(data = growth_2020, na.action = na.omit,
               Growth ~ Garden * Region +
               (1|Population) + (1|mBed) +
               (Garden|Family)) # G x E

Growth_mod1a <- lmer(data = growth_2020, na.action = na.omit,
               Growth ~ Garden * Region +
               (1|Population) + (1|mBed) + (1|Family))

Growth_mod1b <- lmer(data = growth_2020, na.action = na.omit,
               Growth ~ Garden * Region +
               (1|Population) + (1|mBed))

# model 1 anova 
anova(Growth_mod1)

# impact of GxE
anova(Growth_mod1, Growth_mod1a) 

# effect of genotype
anova(Growth_mod1a, Growth_mod1b)

# model 1 vs 3
anova(Growth_mod1, Growth_mod1b)

# the effect of genotype has higher magnitude of significance compared to the 
# effect of GxE

# GxE is of higher magnitude effect when not accounting for family
anova(Growth_mod1, Growth_mod1b)

# LRT 
anova(Growth_mod1,Growth_mod1a,Growth_mod1b)

# AIC
AIC(Growth_mod1,Growth_mod1a,Growth_mod1b)


# effect size estimates for growth trait
plot_model(Growth_mod1, vline.color = "red", sort.est=TRUE, show.values = T, value.offset = .3) + 
  theme_minimal() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12,face="bold"),
        strip.text.x = element_text(size = 12, colour = "black", angle = 0, face="bold"))
```

```{r}
# diagnostic tests for the model
# sjPlot::plot_model(Growth19_mod1, type = "diag")

tab_model(Growth_mod1)
```

## Bud Set 2019    
```{r}
budset_2019 <- budset_2019%>% unite(mBed, Garden, Bed, sep = "_", remove = FALSE)

## working model for growth - ****
budset19_mod1 <- lmer(data = budset_2019, na.action = na.omit,
               BudSet ~ Garden * Region +
               (1|Population) + (1|mBed) +
               (Garden|Family)) # G x E
```




```{r}
budset19_mod1a <- lmer(data = budset_2019, na.action = na.omit,
               BudSet ~ Garden * Region +
               (1|Population) + (1|mBed) + (1|Family))

budset19_mod1b <- lmer(data = budset_2019, na.action = na.omit,
               BudSet ~ Garden * Region +
               (1|Population) + (1|mBed))

# model 1 anova 
anova(budset19_mod1)

# impact of GxE
anova(budset19_mod1, budset19_mod1a) 

# effect of genotype
anova(budset19_mod1a, budset19_mod1b)

# model 1 vs 3
anova(budset19_mod1, budset19_mod1b)

# the effect of genotype has higher magnitude of significance compared to the 
# effect of GxE

# GxE is of higher magnitude effect when not accounting for family
anova(budset19_mod1, budset19_mod1b)

# LRT 
anova(budset19_mod1,budset19_mod1a,budset19_mod1b)

# AIC
AIC(budset19_mod1,budset19_mod1a,budset19_mod1b)


# effect size estimates for budset trait
plot_model(budset19_mod1, vline.color = "red", sort.est=TRUE, show.values = T, value.offset = .3) + 
  theme_minimal() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12,face="bold"),
        strip.text.x = element_text(size = 12, colour = "black", angle = 0, face="bold"))
```

```{r}
tab_model(budset19_mod1)
```

## Bud Set 2020    
```{r}
budset_2020 <- budset_2020%>% unite(mBed, Garden, Bed, sep = "_", remove = FALSE)


## working model for growth - ****
budset20_mod1 <- lmer(data = budset_2020, na.action = na.omit,
               BudSet ~ Garden * Region +
               (1|Population) + (1|mBed) +
               (Garden|Family)) # G x E

budset20_mod1a <- lmer(data = budset_2020, na.action = na.omit,
               BudSet ~ Garden * Region +
               (1|Population) + (1|mBed) + (1|Family))

budset20_mod1b <- lmer(data = budset_2020, na.action = na.omit,
               BudSet ~ Garden * Region +
               (1|Population) + (1|mBed))

# model 1 anova 
anova(budset20_mod1)

# impact of GxE
anova(budset20_mod1, budset20_mod1a) 

# effect of genotype
anova(budset20_mod1a, budset20_mod1b)

# model 1 vs 3
anova(budset20_mod1, budset20_mod1b)

# the effect of genotype has higher magnitude of significance compared to the 
# effect of GxE

# GxE is of higher magnitude effect when not accounting for family
anova(budset20_mod1, budset20_mod1b)

# LRT 
anova(budset20_mod1,budset20_mod1a,budset20_mod1b)

# AIC
AIC(budset20_mod1,budset20_mod1a,budset20_mod1b)


# effect size estimates for budset trait
plot_model(budset20_mod1, vline.color = "red", sort.est=TRUE, show.values = T, value.offset = .3) + 
  theme_minimal() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12,face="bold"),
        strip.text.x = element_text(size = 12, colour = "black", angle = 0, face="bold"))
```

```{r}
tab_model(budset20_mod1)
```

## Bud Break 2020   
- cGDD   
```{r}
budbreak_2020 <- budbreak_2020%>% unite(mBed, Garden, Bed, sep = "_", remove = FALSE)

## working model for bud break - ****
budbreak_mod1 <- lmer(data = budbreak_2020, na.action = na.omit,
               cGDD ~ Garden * Region +
               (1|Population) + (1|mBed) +
               (Garden|Family)) # G x E

budbreak_mod1a <- lmer(data = budbreak_2020, na.action = na.omit,
               cGDD ~ Garden * Region +
               (1|Population) + (1|mBed) + (1|Family))

budbreak_mod1b <- lmer(data = budbreak_2020, na.action = na.omit,
               cGDD ~ Garden * Region +
               (1|Population) + (1|mBed))

# model 1 anova 
anova(budbreak_mod1)

# impact of GxE
anova(budbreak_mod1, budbreak_mod1a) 

# effect of genotype
anova(budbreak_mod1a, budbreak_mod1b)

# model 1 vs 3
anova(budbreak_mod1, budbreak_mod1b)

# the effect of genotype has higher magnitude of significance compared to the 
# effect of GxE

# GxE is of higher magnitude effect when not accounting for family
anova(budbreak_mod1, budbreak_mod1b)

# LRT 
anova(budbreak_mod1,budbreak_mod1a,budbreak_mod1b)

# AIC
AIC(budbreak_mod1,budbreak_mod1a,budbreak_mod1b)


# effect size estimates for budbreak trait
plot_model(budbreak_mod1, vline.color = "red", sort.est=TRUE, show.values = T, value.offset = .3) + 
  theme_minimal() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12,face="bold"),
        strip.text.x = element_text(size = 12, colour = "black", angle = 0, face="bold"))
```

```{r}
tab_model(budbreak_mod1)
```

# Visualization  {.tabset .tabset-fade .tabset-pills}    

## Growth    

**2019**    
 
***Family plot***  
```{r}
### Reaction norm for growth
# remove mbed to get proper reaction norms
# the presence of mbeds complicates the reaction norm otherwise
Growth19_mod_nMb <- lmer(data = growth_2019,
               Growth ~ Garden * Region +
               (1|Population) + 
               (Garden|Family))

heightData19 <- growth_2019
heightData19$pred <- predict(Growth19_mod_nMb)

# merge climateNA data
heightData19 <- merge(x=heightData19,
                     y=Population_climateNA[,c("Population","PC1","MAT")],
                     by="Population")


# faceting by regions
# the geographic region labels are based on the genotypic differences as well
G19 <- ggplot(heightData19,aes(Garden,Growth))+
    facet_grid(.~Region)
    # zero_margin



# Rxn - family
G19_A <- G19 + geom_line(aes(y=pred,group=Family,colour=PC1)) +
                            xlab("") + ylab("Growth in 2019 (cm)") +
            scale_color_viridis(option = "A", direction = -1) +
            theme_bw() + theme(axis.text=element_text(size=18), 
                               axis.title=element_text(size=20,face="bold"),
                               legend.title = element_text(color = "black", size = 14),
                               legend.text = element_text(color = "black", size = 13)) + 
        scale_x_discrete(labels=c("Vermont" = "VT", "Maryland" = "MD", "North_Carolina" = "NC")) + 
        theme(strip.text.x = element_text(size = 30))

```

***Region plot***   
```{r}
# Rxn - population
growth19_pop_rxn <- G19 + geom_line(aes(y=pred,group=Family,colour=Population)) +
                  xlab("Garden site") + ylab("Vertical height growth (in cm)") +
  theme_minimal() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12,face="bold"),
        strip.text.x = element_text(size = 12, colour = "black", angle = 0, face="bold"))




## Reaction norm for geo genetic groups/regions
# growth reaction norm
G19_B <-      ggplot(heightData19,
                   aes(x=Garden, y=Growth, color=Region)) +
              stat_summary(aes(group = Region), fun.y = mean, geom = "path", size = 1.5) +
              stat_summary(aes(color = Region), fun.data = mean_cl_boot, geom = "errorbar", width = 0.1, size=1.5) +
              stat_summary(aes(color = Region), fun.y = mean, geom = "point", size = 5) + 
              # Lines by species using grouping
              stat_summary(aes(group = Region), geom = "line", fun = mean) +
              ylab("") + xlab("") + 
              theme(legend.position="right") +
              theme_bw() + theme(axis.text=element_text(size=18), 
                                   axis.title=element_text(size=20,face="bold"),
                                   legend.title = element_text(color = "black", size = 14),
                                   legend.text = element_text(color = "black", size = 13)) +
              scale_color_manual(values = c("Core" = "goldenrod2","Margin"="green2", "Edge"="steelblue"))
```



**2020**    

***Family plot***  
```{r}
### Reaction norm for growth
# remove mbed to get proper reaction norms
# the presence of mbeds complicates the reaction norm otherwise
Growth20_mod_nMb <- lmer(data = growth_2020,
               Growth ~ Garden * Region +
               (1|Population) + 
               (Garden|Family))

heightData20 <- growth_2020
heightData20$pred <- predict(Growth20_mod_nMb)

# merge climateNA data
heightData20 <- merge(x=heightData20,
                     y=Population_climateNA[,c("Population","PC1","MAT")],
                     by="Population")


# faceting by regions
# the geographic region labels are based on the genotypic differences as well
G20 <- ggplot(heightData20,aes(Garden,Growth))+
    facet_grid(.~Region)
    # zero_margin

# Rxn - family
G20_C <-  G20 + geom_line(aes(y=pred,group=Family,colour=PC1)) +
                          xlab("") + ylab("Growth in 2020 (cm)") +
          scale_color_viridis(option = "A", direction = -1) +
          theme_bw() + theme(axis.text=element_text(size=18), 
                               axis.title=element_text(size=20,face="bold"),
                               legend.title = element_text(color = "black", size = 14),
                               legend.text = element_text(color = "black", size = 13)) + 
        scale_x_discrete(labels=c("Vermont" = "VT", "Maryland" = "MD", "North_Carolina" = "NC")) + 
        theme(strip.text.x = element_text(size = 30))

```

***Region plot***   
```{r}
# Rxn - population
growth20_pop_rxn <- G20 + geom_line(aes(y=pred,group=Family,colour=Population)) +
                  xlab("Garden site") + ylab("Vertical height growth (in cm)") +
  theme_minimal() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12,face="bold"),
        strip.text.x = element_text(size = 12, colour = "black", angle = 0, face="bold"))




## Reaction norm for geo genetic groups/regions
# growth reaction norm
G20_D <-  ggplot(heightData20,
               aes(x=Garden, y=Growth, color=Region)) +
          stat_summary(aes(group = Region), fun.y = mean, geom = "path", size = 1.5) +
              stat_summary(aes(color = Region), fun.data = mean_cl_boot, geom = "errorbar", width = 0.1, size=1.5) +
              stat_summary(aes(color = Region), fun.y = mean, geom = "point", size = 5) + 
              # Lines by species using grouping
              stat_summary(aes(group = Region), geom = "line", fun = mean) +
              ylab("") + xlab("") + 
              theme(legend.position="right") +
              theme_bw() + theme(axis.text=element_text(size=18), 
                                   axis.title=element_text(size=20,face="bold"),
                                   legend.title = element_text(color = "black", size = 14),
                                   legend.text = element_text(color = "black", size = 13)) +
              scale_color_manual(values = c("Core" = "goldenrod2","Margin"="green2", "Edge"="steelblue"))
```





**Combined plot for growth**  
```{r}


legend_PC <- get_legend(G20_C) 
legend_RE <- get_legend(G20_D)

leg_full <- plot_grid(legend_PC, legend_RE,
                   nrow = 2)

G_grid <- plot_grid(G19_A + theme(legend.position="none"),
                         G19_B + theme(legend.position="none"),
                         G20_C + theme(legend.position="none"),
                         G20_D + theme(legend.position="none"),
                         align = 'vh',
                         labels = c("A", "B","C", "D"),
                         hjust = -1,
                         nrow = 2,
                         rel_widths = c(1,.7))
# bud set final 
plot_grid(G_grid, leg_full, ncol = 2, rel_widths = c(1,.05))
  
```


## Phenology     

**Bud set 2019 (DOY)**  

***Family plot***  
```{r}
### Reaction norm for growth
# remove mbed to get proper reaction norms
# the presence of mbeds complicates the reaction norm otherwise
budset19_mod_nMb <- lmer(data = budset_2019,
               BudSet ~ Garden * Region +
               (1|Population) + 
               (Garden|Family))

budset_2019_2 <- budset_2019
budset_2019_2$pred <- predict(budset19_mod_nMb)

# merge climateNA data
budset_2019_2 <- merge(x=budset_2019_2,
                     y=Population_climateNA[,c("Population","PC1","MAT")],
                     by="Population")


# faceting by regions
# the geographic region labels are based on the genotypic differences as well
BS19 <- ggplot(budset_2019_2,aes(Garden,BudSet))+
    facet_grid(.~Region)
    # zero_margin

# Rxn - family
BS19_A <-     BS19 + geom_line(aes(y=pred,group=Family,colour=PC1)) +
                              xlab("") + ylab("Bud set in 2019 (DOY)") +
              scale_color_viridis(option = "A", direction = -1) +
              theme_bw() + theme(axis.text=element_text(size=18), 
                               axis.title=element_text(size=20,face="bold"),
                               legend.title = element_text(color = "black", size = 14),
                               legend.text = element_text(color = "black", size = 13)) + 
        scale_x_discrete(labels=c("Vermont" = "VT", "Maryland" = "MD", "North_Carolina" = "NC")) + 
        theme(strip.text.x = element_text(size = 30))

```

***Region plot***  
```{r}
# Rxn - population
budset19_pop_rxn <- BS19 + geom_line(aes(y=pred,group=Family,colour=Population)) +
                  xlab("Garden site") + ylab("Bud set in 2019 (DOY)") +
  theme_minimal() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12,face="bold"),
        strip.text.x = element_text(size = 12, colour = "black", angle = 0, face="bold"))


## Reaction norm for geo genetic groups/regions
# growth reaction norm
BS19_B <- ggplot(budset_2019_2,
             aes(x=Garden, y=BudSet, color=Region)) +
          stat_summary(aes(group = Region), fun.y = mean, geom = "path", size = 1.5) +
              stat_summary(aes(color = Region), fun.data = mean_cl_boot, geom = "errorbar", width = 0.1, size=1.5) +
              stat_summary(aes(color = Region), fun.y = mean, geom = "point", size = 5) + 
              # Lines by species using grouping
              stat_summary(aes(group = Region), geom = "line", fun = mean) +
              ylab("") + xlab("") + 
              theme(legend.position="right") +
              theme_bw() + theme(axis.text=element_text(size=18), 
                                   axis.title=element_text(size=20,face="bold"),
                                   legend.title = element_text(color = "black", size = 14),
                                   legend.text = element_text(color = "black", size = 13)) +
              scale_color_manual(values = c("Core" = "goldenrod2","Margin"="green2", "Edge"="steelblue"))
```

**Bud set 2020 (DOY)**    

***Family plot***   

```{r}
### Reaction norm for growth
# remove mbed to get proper reaction norms
# the presence of mbeds complicates the reaction norm otherwise
budset20_mod_nMb <- lmer(data = budset_2020,
               BudSet ~ Garden * Region +
               (1|Population) + 
               (Garden|Family))

budset_2020_2 <- budset_2020
budset_2020_2$pred <- predict(budset20_mod_nMb)

# merge climateNA data
budset_2020_2 <- merge(x=budset_2020_2,
                     y=Population_climateNA[,c("Population","PC1","MAT")],
                     by="Population")


# faceting by regions
# the geographic region labels are based on the genotypic differences as well
BS20 <- ggplot(budset_2020_2,aes(Garden,BudSet))+
    facet_grid(.~Region)
    # zero_margin

# Rxn - family
BS20_C <- BS20 + geom_line(aes(y=pred,group=Family,colour=PC1)) +
                                  xlab("") + ylab("Bud set in 2020 (DOY)") +
                  scale_color_viridis(option = "A", direction = -1) +
                  theme_bw() + theme(axis.text=element_text(size=18), 
                               axis.title=element_text(size=20,face="bold"),
                               legend.title = element_text(color = "black", size = 14),
                               legend.text = element_text(color = "black", size = 13)) + 
        scale_x_discrete(labels=c("Vermont" = "VT", "Maryland" = "MD", "North_Carolina" = "NC")) + 
        theme(strip.text.x = element_text(size = 30))

```


***Region plot***  
```{r}
# Rxn - population
budset20_pop_rxn <- BS20 + geom_line(aes(y=pred,group=Family,colour=Population)) +
                  xlab("Garden site") + ylab("Bud set in 2020 (DOY)") +
  theme_minimal() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12,face="bold"),
        strip.text.x = element_text(size = 12, colour = "black", angle = 0, face="bold"))


## Reaction norm for geo genetic groups/regions
# growth reaction norm
BS20_D <- ggplot(budset_2020_2,
               aes(x=Garden, y=BudSet, color=Region)) +
          stat_summary(aes(group = Region), fun.y = mean, geom = "path", size = 1.5) +
              stat_summary(aes(color = Region), fun.data = mean_cl_boot, geom = "errorbar", width = 0.1, size=1.5) +
              stat_summary(aes(color = Region), fun.y = mean, geom = "point", size = 5) + 
              # Lines by species using grouping
              stat_summary(aes(group = Region), geom = "line", fun = mean) +
              ylab("") + xlab("") + 
              theme(legend.position="right") +
              theme_bw() + theme(axis.text=element_text(size=18), 
                                   axis.title=element_text(size=20,face="bold"),
                                   legend.title = element_text(color = "black", size = 14),
                                   legend.text = element_text(color = "black", size = 13)) +
              scale_color_manual(values = c("Core" = "goldenrod2","Margin"="green2", "Edge"="steelblue"))
```


**Combined plot for bud set**  
```{r}


legend_PC <- get_legend(BS20_C) 
legend_RE <- get_legend(BS20_D)

leg_full <- plot_grid(legend_PC, legend_RE,
                   nrow = 2)

BS_grid <- plot_grid(BS19_A + theme(legend.position="none"),
                         BS19_B + theme(legend.position="none"),
                         BS20_C + theme(legend.position="none"),
                         BS20_D + theme(legend.position="none"),
                         align = 'vh',
                         labels = c("A", "B","C", "D"),
                         hjust = -1,
                         nrow = 2,
                         rel_widths = c(1,.7))
# bud set final 
plot_grid(BS_grid, leg_full, ncol = 2, rel_widths = c(1,.05))
  
```


**Bud Break 2020 (cGDD)**    

***Family plot***   
```{r}
### Reaction norm for growth
# remove mbed to get proper reaction norms
# the presence of mbeds complicates the reaction norm otherwise
budbreak_mod_nMb <- lmer(data = budbreak_2020,
               cGDD ~ Garden * Region +
               (1|Population) + 
               (Garden|Family))

budbreak <- budbreak_2020[!is.na(budbreak_2020$cGDD),]
budbreak$pred <- predict(budbreak_mod_nMb)

# merge climateNA data
budbreak <- merge(x=budbreak,
                   y=Population_climateNA[,c("Population","PC1","MAT")],
                   by="Population")

# faceting by regions
# the geographic region labels are based on the genotypic differences as well
BB20 <- ggplot(budbreak,aes(Garden,cGDD))+
    facet_grid(.~Region)
    # zero_margin

# Rxn - family
BB20_A <- BB20 + geom_line(aes(y=pred,group=Family,colour=PC1)) +
                                  xlab("") + ylab("Bud break in 2020 (cGDD)") +
                  scale_color_viridis(option = "A", direction = -1) +
                  theme_bw() + theme(axis.text=element_text(size=18), 
                               axis.title=element_text(size=20,face="bold"),
                               legend.title = element_text(color = "black", size = 14),
                               legend.text = element_text(color = "black", size = 13)) + 
        scale_x_discrete(labels=c("Vermont" = "VT", "Maryland" = "MD", "North_Carolina" = "NC")) + 
        theme(strip.text.x = element_text(size = 30))

```

***Region plot***   
```{r}
# Rxn - population
budbreak_pop_rxn <- BB20 + geom_line(aes(y=pred,group=Family,colour=Population)) +
                  xlab("Garden site") + ylab("cGDD") +
  theme_minimal() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12,face="bold"),
        strip.text.x = element_text(size = 12, colour = "black", angle = 0, face="bold"))


## Reaction norm for geo genetic groups/regions
BB20_B <- ggplot(budbreak,
               aes(x=Garden, y=cGDD, color=Region)) +
          stat_summary(aes(group = Region), fun.y = mean, geom = "path", size = 1.5) +
              stat_summary(aes(color = Region), fun.data = mean_cl_boot, geom = "errorbar", width = 0.1, size=1.5) +
              stat_summary(aes(color = Region), fun.y = mean, geom = "point", size = 5) + 
              # Lines by species using grouping
              stat_summary(aes(group = Region), geom = "line", fun = mean) +
              ylab("") + xlab("") + 
              theme(legend.position="right") +
              theme_bw() + theme(axis.text=element_text(size=18), 
                                   axis.title=element_text(size=20,face="bold"),
                                   legend.title = element_text(color = "black", size = 14),
                                   legend.text = element_text(color = "black", size = 13)) +
              scale_color_manual(values = c("Core" = "goldenrod2","Margin"="green2", "Edge"="steelblue"))
```


**Combined plot for bud break - cGDD**  
```{r}
legend_PC <- get_legend(BB20_A) 
legend_RE <- get_legend(BB20_B)

leg_full <- plot_grid(legend_PC, legend_RE,
                   nrow = 2)

BB_grid <- plot_grid(BB20_A + theme(legend.position="none"),
                         BB20_B + theme(legend.position="none"),
                         align = 'vh',
                         labels = c("A", "B"),
                         hjust = -1,
                         nrow = 1,
                         rel_widths = c(1,.7))
# bud set final 
plot_grid(BB_grid, leg_full, ncol = 2, rel_widths = c(1,.08))
  
```

## Figure in text  

```{r}
A <- ggplot(budset_2019_2,
             aes(x=Garden, y=BudSet, color=Region)) +
          stat_summary(aes(group = Region), fun.y = mean, geom = "path", size = 1.5) +
              stat_summary(aes(color = Region), fun.data = mean_cl_boot, geom = "errorbar", width = 0.1, size=1.5) +
              stat_summary(aes(color = Region), fun.y = mean, geom = "point", size = 5) + 
              # Lines by species using grouping
              stat_summary(aes(group = Region), geom = "line", fun = mean) +
              ylab("Bud set (DOY)") + xlab("") + 
              theme(legend.position="right") +
              theme_bw() + theme(axis.text=element_text(size=18), 
                                   axis.title=element_text(size=20,face="bold"),
                                   legend.title = element_text(color = "black", size = 14),
                                   legend.text = element_text(color = "black", size = 13)) +
              scale_color_manual(values = c("Core" = "goldenrod2","Margin"="green2", "Edge"="steelblue"))

B <- ggplot(budset_2020_2,
               aes(x=Garden, y=BudSet, color=Region)) +
          stat_summary(aes(group = Region), fun.y = mean, geom = "path", size = 1.5) +
              stat_summary(aes(color = Region), fun.data = mean_cl_boot, geom = "errorbar", width = 0.1, size=1.5) +
              stat_summary(aes(color = Region), fun.y = mean, geom = "point", size = 5) + 
              # Lines by species using grouping
              stat_summary(aes(group = Region), geom = "line", fun = mean) +
              ylab("") + xlab("") + 
              theme(legend.position="right") +
              theme_bw() + theme(axis.text=element_text(size=18), 
                                   axis.title=element_text(size=20,face="bold"),
                                   legend.title = element_text(color = "black", size = 14),
                                   legend.text = element_text(color = "black", size = 13)) +
              scale_color_manual(values = c("Core" = "goldenrod2","Margin"="green2", "Edge"="steelblue"))

C <- ggplot(budbreak,
               aes(x=Garden, y=cGDD, color=Region)) +
          stat_summary(aes(group = Region), fun.y = mean, geom = "path", size = 1.5) +
              stat_summary(aes(color = Region), fun.data = mean_cl_boot, geom = "errorbar", width = 0.1, size=1.5) +
              stat_summary(aes(color = Region), fun.y = mean, geom = "point", size = 5) + 
              # Lines by species using grouping
              stat_summary(aes(group = Region), geom = "line", fun = mean) +
              ylab("Bud break (cGDD)") + xlab("") + 
              theme(legend.position="right") +
              theme_bw() + theme(axis.text=element_text(size=18), 
                                   axis.title=element_text(size=20,face="bold"),
                                   legend.title = element_text(color = "black", size = 14),
                                   legend.text = element_text(color = "black", size = 13)) +
              scale_color_manual(values = c("Core" = "goldenrod2","Margin"="green2", "Edge"="steelblue"))


D <-      ggplot(heightData19,
                   aes(x=Garden, y=Growth, color=Region)) + 
              stat_summary(aes(group = Region), fun.y = mean, geom = "path", size = 1.5) +
              stat_summary(aes(color = Region), fun.data = mean_cl_boot, geom = "errorbar", width = 0.1, size=1.5) +
              stat_summary(aes(color = Region), fun.y = mean, geom = "point", size = 5) + 
              # Lines by species using grouping
              stat_summary(aes(group = Region), geom = "line", fun = mean) +
              ylab("Growth (cm)") + xlab("2019") + 
              theme(legend.position="right") +
              theme_bw() + theme(axis.text=element_text(size=18), 
                                   axis.title=element_text(size=20,face="bold"),
                                   legend.title = element_text(color = "black", size = 14),
                                   legend.text = element_text(color = "black", size = 13)) +
              scale_color_manual(values = c("Core" = "goldenrod2","Margin"="green2", "Edge"="steelblue"))

E <-  ggplot(heightData20,
               aes(x=Garden, y=Growth, color=Region)) +
          stat_summary(aes(group = Region), fun.y = mean, geom = "path", size = 1.5) +
              stat_summary(aes(color = Region), fun.data = mean_cl_boot, geom = "errorbar", width = 0.1, size=1.5) +
              stat_summary(aes(color = Region), fun.y = mean, geom = "point", size = 5) + 
              # Lines by species using grouping
              stat_summary(aes(group = Region), geom = "line", fun = mean) +
              ylab("") + xlab("2020") + 
              theme(legend.position="right") +
              theme_bw() + theme(axis.text=element_text(size=18), 
                                   axis.title=element_text(size=20,face="bold"),
                                   legend.title = element_text(color = "black", size = 20),
                                   legend.text = element_text(color = "black", size = 18)) +
              scale_color_manual(values = c("Core" = "goldenrod2","Margin"="green2", "Edge"="steelblue"))

legend <- get_legend(E + theme(legend.position="right"))
HA_grid <- cowplot::plot_grid( A + theme(legend.position="none"),
           B + theme(legend.position="none"),
           legend,
           C + theme(legend.position="none"),
           D + theme(legend.position="none"),
           E + theme(legend.position="none"),
           align = 'vh',
           labels = c("A", "B","" ,"C", "D","E"),
           hjust = -1,
           nrow = 3
           )
HA_grid
```


## Supplementary  

***GxE at family level***  
```{r}
S.A <-     BS19 + geom_line(aes(y=pred,group=Family,colour=PC1)) +
                              xlab("") + ylab("Bud set (DOY)") +
              scale_color_viridis(option = "A", direction = -1) +
              theme_bw() + theme(axis.text=element_text(size=18), 
                               axis.title=element_text(size=20,face="bold"),
                               legend.title = element_text(color = "black", size = 14),
                               legend.text = element_text(color = "black", size = 13)) + 
        scale_x_discrete(labels=c("Vermont" = "VT", "Maryland" = "MD", "North_Carolina" = "NC")) + 
        theme(strip.text.x = element_text(size = 30))

S.B <- BS20 + geom_line(aes(y=pred,group=Family,colour=PC1)) +
                                  xlab("") + ylab("") +
                  scale_color_viridis(option = "A", direction = -1) +
                  theme_bw() + theme(axis.text=element_text(size=18), 
                               axis.title=element_text(size=20,face="bold"),
                               legend.title = element_text(color = "black", size = 14),
                               legend.text = element_text(color = "black", size = 13)) + 
        scale_x_discrete(labels=c("Vermont" = "VT", "Maryland" = "MD", "North_Carolina" = "NC")) + 
        theme(strip.text.x = element_text(size = 30))

S.C <- BB20 + geom_line(aes(y=pred,group=Family,colour=PC1)) +
                                  xlab("") + ylab("Bud break (cGDD)") +
                  scale_color_viridis(option = "A", direction = -1) +
                  theme_bw() + theme(axis.text=element_text(size=18), 
                               axis.title=element_text(size=20,face="bold"),
                               legend.title = element_text(color = "black", size = 14),
                               legend.text = element_text(color = "black", size = 13)) + 
        scale_x_discrete(labels=c("Vermont" = "VT", "Maryland" = "MD", "North_Carolina" = "NC")) + 
        theme(strip.text.x = element_text(size = 30))

S.D <- G19 + geom_line(aes(y=pred,group=Family,colour=PC1)) +
                            xlab("2019") + ylab("Growth (cm)") +
            scale_color_viridis(option = "A", direction = -1) +
            theme_bw() + theme(axis.text=element_text(size=18), 
                               axis.title=element_text(size=20,face="bold"),
                               legend.title = element_text(color = "black", size = 14),
                               legend.text = element_text(color = "black", size = 13)) + 
        scale_x_discrete(labels=c("Vermont" = "VT", "Maryland" = "MD", "North_Carolina" = "NC")) + 
        theme(strip.text.x = element_text(size = 30))

S.E <-  G20 + geom_line(aes(y=pred,group=Family,colour=PC1)) +
                          xlab("2020") + ylab("") +
          scale_color_viridis(option = "A", direction = -1) +
          theme_bw() + theme(axis.text=element_text(size=18), 
                               axis.title=element_text(size=20,face="bold"),
                               legend.title = element_text(color = "black", size = 14),
                               legend.text = element_text(color = "black", size = 13)) + 
        scale_x_discrete(labels=c("Vermont" = "VT", "Maryland" = "MD", "North_Carolina" = "NC")) + 
        theme(strip.text.x = element_text(size = 30))

legend <- get_legend(S.E + theme(legend.position="right"))
SA_grid <- cowplot::plot_grid( S.A + theme(legend.position="none"),
           S.B + theme(legend.position="none"),
           legend,
           S.C + theme(legend.position="none"),
           S.D + theme(legend.position="none"),
           S.E + theme(legend.position="none"),
           align = 'vh',
           labels = c("A", "B","" ,"C", "D","E"),
           hjust = -1,
           nrow = 3
           )
SA_grid
```

**Bud break 2020 (DOY)**  

***Family plot***   
```{r}
### Reaction norm for growth
# remove mbed to get proper reaction norms
# the presence of mbeds complicates the reaction norm otherwise
budbreak_DOY_mod_nMb <- lmer(data = budbreak_2020,
               BudBreak ~ Garden * Region +
               (1|Population) + 
               (Garden|Family))

budbreak <- budbreak_2020[!is.na(budbreak_2020$BudBreak),]
budbreak$pred <- predict(budbreak_DOY_mod_nMb)

# merge climateNA data
budbreak <- merge(x=budbreak,
                   y=Population_climateNA[,c("Population","PC1","MAT")],
                   by="Population")

# faceting by regions
# the geographic region labels are based on the genotypic differences as well
BB20_DOY <- ggplot(budbreak,aes(Garden,BudBreak))+
    facet_grid(.~Region)
    # zero_margin

# Rxn - family
BB20_DOY_A <- BB20_DOY + geom_line(aes(y=pred,group=Family,colour=PC1)) +
                                xlab("") + ylab("Bud break in 2020 (DOY)") +
                scale_color_viridis(option = "A", direction = -1) +
                theme_bw() + theme(axis.text=element_text(size=18), 
                               axis.title=element_text(size=20,face="bold"),
                               legend.title = element_text(color = "black", size = 14),
                               legend.text = element_text(color = "black", size = 13)) + 
        scale_x_discrete(labels=c("Vermont" = "VT", "Maryland" = "MD", "North_Carolina" = "NC")) + 
        theme(strip.text.x = element_text(size = 30))

```

***Region plot***   
```{r}
# Rxn - population
budbreak_DOY_pop_rxn <- BB20_DOY + geom_line(aes(y=pred,group=Family,colour=Population)) +
                  xlab("Garden site") + ylab("DOY") +
  theme_minimal() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12,face="bold"),
        strip.text.x = element_text(size = 12, colour = "black", angle = 0, face="bold"))


## Reaction norm for geo genetic groups/regions
BB20_DOY_B <- ggplot(budbreak,
                           aes(x=Garden, y=BudBreak, color=Region)) +
                      stat_summary(aes(group = Region), fun.y = mean, geom = "path", size = 1.5) +
              stat_summary(aes(color = Region), fun.data = mean_cl_boot, geom = "errorbar", width = 0.1, size=1.5) +
              stat_summary(aes(color = Region), fun.y = mean, geom = "point", size = 5) + 
              # Lines by species using grouping
              stat_summary(aes(group = Region), geom = "line", fun = mean) +
              ylab("") + xlab("") + 
              theme(legend.position="right") +
              theme_bw() + theme(axis.text=element_text(size=18), 
                                   axis.title=element_text(size=20,face="bold"),
                                   legend.title = element_text(color = "black", size = 14),
                                   legend.text = element_text(color = "black", size = 13)) +
              scale_color_manual(values = c("Core" = "goldenrod2","Margin"="green2", "Edge"="steelblue"))
```

**Combined plot - Supplementary figure**  
```{r}
legend_PC <- get_legend(BB20_DOY_A) 
legend_RE <- get_legend(BB20_DOY_B)

leg_full <- cowplot::plot_grid(legend_PC, legend_RE,
                   nrow = 2)

BB_DOY_grid <- cowplot::plot_grid(BB20_DOY_A + theme(legend.position="none"),
                         BB20_DOY_B + theme(legend.position="none"),
                         align = 'vh',
                         labels = c("A", "B"),
                         hjust = -1,
                         nrow = 1,
                         rel_widths = c(1,.7))
# bud set DOY final 
cowplot::plot_grid(BB_DOY_grid, leg_full, ncol = 2, rel_widths = c(1,.08))
  
```

